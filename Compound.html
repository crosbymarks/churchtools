<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="docTitle">Ultimate Real-Time Compound Interest Simulator</title>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding-top: 40px;
            margin: 0;
        }

        .container {
            background: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
            width: 100%;
            max-width: 600px;
        }

        h1 {
            color: #0056b3;
            text-align: center;
            margin-bottom: 30px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .input-group input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        /* --- Advanced Settings Dropdown --- */
        .advanced-toggle {
            display: block;
            background-color: #e9ecef;
            color: #495057;
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
            font-weight: bold;
            margin-bottom: 15px;
            transition: background-color 0.2s;
        }

        .advanced-toggle:hover {
            background-color: #dee2e6;
        }

        #advancedSettings {
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            background-color: #f8f9fa;
        }
        
        #advancedSettings .input-group {
            margin-bottom: 10px;
        }
        
        /* --- Instant Calculate Section --- */
        #calculateSection {
            padding-top: 15px;
            margin-top: 15px;
            border-top: 1px solid #dee2e6;
        }
        
        #calculateSection .input-group {
            display: flex;
            gap: 10px;
            align-items: flex-end;
            margin-bottom: 0;
        }
        
        #calculateSection input {
            flex-grow: 1;
        }

        #calculateButton {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            flex-shrink: 0;
            font-weight: bold;
        }

        #calculateButton:hover {
            background-color: #0056b3;
        }
        
        #projectionResult {
            margin-top: 15px;
            padding: 10px;
            border: 1px dashed #007bff;
            border-radius: 4px;
            text-align: center;
            background-color: #e6f7ff;
            font-weight: bold;
            display: none; /* Hidden by default */
        }
        
        /* --- Controls Styling (Speed, Action, Popout) --- */
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .action-buttons button, .speed-controls button, .size-controls button, #popoutButton {
            padding: 10px 15px;
            margin-right: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }
        
        .speed-controls {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }

        #popoutButton {
            background-color: #ffc107; /* Popout color */
            color: #333;
            margin-left: 10px;
        }
        
        #popoutButton:hover {
            background-color: #e0a800;
        }

        #startButton { background-color: #28a745; color: white; }
        #startButton:hover:not([disabled]) { background-color: #1e7e34; }

        #stopButton { background-color: #dc3545; color: white; }
        #stopButton:hover:not([disabled]) { background-color: #c82333; }

        .speed-controls label, .size-controls label { margin-right: 10px; font-weight: bold; }
        .speed-controls button, .size-controls button { background-color: #f0f0f0; color: #333; border: 1px solid #ccc; }
        .speed-controls button.active, .size-controls button.active { background-color: #007bff; color: white; border-color: #007bff; }

        button:disabled { opacity: 0.6; cursor: not-allowed; }

        /* Highlighted Total Value Container (Main Results) */
        #totalValueDisplay {
            margin: 20px 0;
            padding: 20px 15px;
            text-align: center;
            background-color: #e6f7ff;
            border: 3px solid #0056b3;
            border-radius: 8px;
        }
        
        #totalValueDisplay p {
            font-size: 1.2em;
            margin: 0;
        }
        
        /* Dynamic size classes for Total Value */
        .size-1x { font-size: 3.5em; } /* Default size */
        .size-2x { font-size: 4.5em; }
        .size-3x { font-size: 5.5em; }
        
        #totalValue {
            font-weight: 900;
            color: #0056b3;
            display: block;
            margin-bottom: 10px;
        }
        
        /* Font Size Controls Styling */
        #fontSizeControlsContainer {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin: 15px 0 0;
            padding: 0 5px;
        }

        .size-controls {
            display: flex;
            align-items: center;
        }
        
        /* Main Breakdown & Comparison Breakdown Styles */
        .breakdown, .comparison-breakdown {
            font-weight: normal;
            color: #333;
            line-height: 1.5;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .breakdown span, .comparison-breakdown span {
            font-weight: bold;
            color: #0056b3;
            display: inline-block;
        }
        
        .breakdown .label, .comparison-breakdown .label {
            color: #666;
            font-weight: normal;
        }
        
        /* Comparison Section */
        #comparisonSection {
            margin-top: 15px;
            padding: 15px;
            background-color: #f0fff0;
            border: 1px solid #c3e6c3;
            border-radius: 4px;
            text-align: center;
            font-size: 0.85em;
        }

        #comparisonSection strong {
            display: block;
            margin-bottom: 10px;
            color: #1e7e34;
            font-size: 1.1em;
        }
        
        #compTotalValue {
            display: block;
            font-size: 1.8em;
            font-weight: bold;
            color: #1e7e34;
            margin-bottom: 5px;
        }

        .note {
            font-size: 0.8em;
            color: #999;
            text-align: right;
            margin-top: 15px;
        }

        /* --- Language Toggle Styles --- */
        .language-toggle {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 25px;
            padding-top: 15px;
            border-top: 1px solid #ccc;
        }

        .language-toggle span {
            font-weight: bold;
            color: #0056b3;
            margin: 0 10px;
        }

        /* The switch - the box around the slider */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        /* Hide default HTML checkbox */
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        /* The slider */
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #2196F3;
        }

        input:checked + .slider:before {
            -webkit-transform: translateX(26px);
            -ms-transform: translateX(26px);
            transform: translateX(26px);
        }
        
        /* --- Popout Window Styles (Internal to JS) --- */
        /* These styles will be injected into the new window */
        .popout-styles-code {
            display: none; /* Hide in main window */
        }
        .home-icon-svg {
            width: 28px;
            height: 28px;
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
    </style>
    <script class="popout-styles-code">
        const popoutStyles = `
            body {
                font-family: Arial, sans-serif;
                background-color: #1a1a2e;
                color: #e6f7ff;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                margin: 0;
                height: 100vh;
                overflow: hidden;
            }
            #popout-container {
                text-align: center;
                padding: 20px;
            }
            #popout-value {
                font-size: 14em; /* Massive size requested */
                font-weight: 900;
                color: #ffc107; /* Highlight color */
                display: block;
                line-height: 1em;
            }
            #popout-time {
                font-size: 2em;
                color: #fff;
                margin-top: 15px;
            }
            #popout-label {
                font-size: 1.5em;
                color: #aaa;
                margin-bottom: 20px;
            }
        `;
    </script>
</head>
<body>
    <div class="container">
                    <!-- Home Icon Link (Upper Left) -->
            <div class="flex justify-start mb-4">
                <a href="./" class="text-gray-600 hover:text-blue-600 transition duration-150 p-2 rounded-full hover:bg-gray-100" aria-label="Go to home page">
                    <svg class="home-icon-svg" viewBox="0 0 24 24">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                    </svg>
                </a>
            </div>
        <h1 id="mainTitle">Ultimate Compound Growth Simulator 🚀</h1>

        <div class="input-group">
            <label id="label_monthlyDeposit" for="initialInvestment">Regular Monthly Deposit ($):</label>
            <input type="number" id="initialInvestment" value="100" min="0" step="0.01">
        </div>

        <div class="input-group">
            <label id="label_yearlyRate" for="yearlyRate">Yearly Percentage Rate (%):</label>
            <input type="number" id="yearlyRate" value="7" min="0.01" step="0.1">
        </div>
        
        <span class="advanced-toggle" id="advancedToggle" onclick="document.getElementById('advancedSettings').style.display = document.getElementById('advancedSettings').style.display === 'block' ? 'none' : 'block';">
            &#9662; Advanced Settings & Projections
        </span>

        <div id="advancedSettings" style="display:none;">
             <div class="input-group">
                <label id="label_initialDeposit" for="initialDeposit">One-Time Initial Deposit ($):</label>
                <input type="number" id="initialDeposit" value="0" min="0" step="0.01">
            </div>
            <div class="input-group">
                <label id="label_stopMonths" for="stopMonths">Stop Monthly Deposits After (Months):</label>
                <input type="number" id="stopMonths" value="0" min="0" step="1" title="Enter 0 to deposit indefinitely.">
            </div>
            
            <hr>
            
            <div id="calculateSection">
                <p id="calcTitle" style="font-weight: bold; margin-top: 0;">Instant Projection Calculator</p>
                <div class="input-group">
                    <label id="label_projectionMonths" for="projectionMonths">Calculate Total Value After (Months):</label>
                    <input type="number" id="projectionMonths" value="360" min="1" step="1">
                    <button id="calculateButton">Calculate</button>
                </div>
                <div id="projectionResult" style="display:none;">
                    <span id="label_projectionResult">Total Projection:</span> <span id="projectedTotalValue"></span> 
                    (<span id="label_projectionTime">Time:</span> <span id="projectedTime"></span>)
                </div>
            </div>
        </div>
        
        <div class="controls">
            <div class="action-buttons">
                <button id="startButton">Start Simulation</button>
                <button id="stopButton" disabled>Stop Simulation</button>
            </div>
            <div class="speed-controls">
                <label id="label_speed">Speed:</label>
                <button id="speed1x" class="active" data-speed="1">x1</button>
                <button id="speed2x" data-speed="2">x2</button>
                <button id="speed4x" data-speed="4">x4</button>
                <button id="speed12x" data-speed="12">x12</button>
                <button id="popoutButton">Popout 🚀</button>
            </div>
        </div>

        <hr>

        <h2 id="resultsTitle">Simulation Results</h2>
        
        <p><span id="label_timeElapsed">Time Elapsed:</span> <span id="timeElapsed">0 Years, 0 Months</span></p>

        <div id="totalValueDisplay">
            <p id="label_yourTotalValue">YOUR TOTAL VALUE:</p>
            <span id="totalValue" class="size-1x">$0.00</span>
            <div class="breakdown">
                <span class="label" id="label_principal">Principal:</span> <span id="principalEntered">$0.00</span> 
                | <span class="label" id="label_totalInterest">Total Interest:</span> <span id="totalInterestPaid">$0.00</span>
                | <span class="label" id="label_lastInterest">Last Interest:</span> <span id="lastInterestPaid">$0.00</span>
            </div>
        </div>
        
        <div id="fontSizeControlsContainer">
            <div class="size-controls">
                <label id="label_size">Size:</label>
                <button id="size1x" class="active" data-size="1">1x</button>
                <button id="size2x" data-size="2">2x</button>
                <button id="size3x" data-size="3">3x</button>
            </div>
        </div>

        <div id="comparisonSection">
            <strong id="compTitle">If you invested $5 more per month (and stopped at the same time):</strong>
            
            <p id="label_newTotalValue" style="font-size: 0.9em; margin-bottom: 5px;">NEW TOTAL VALUE:</p>
            <span id="compTotalValue">$0.00</span>

            <div class="comparison-breakdown">
                <span class="label" id="label_compPrincipal">Principal:</span> <span id="compPrincipal">$0.00</span> 
                | <span class="label" id="label_compTotalInterest">Total Interest:</span> <span id="compTotalInterest">$0.00</span>
                | <span class="label" id="label_compLastInterest">Last Interest:</span> <span id="compLastInterest">$0.00</span>
            </div>
            <p style="margin-top: 10px; font-weight: bold; font-size: 1.1em;">
                <span id="label_totalDifference">Total Difference:</span> <span id="totalDifference">$0.00</span>
            </p>
        </div>

        <p class="note" id="noteText">
            * 1x speed means one minute in real-time equals one month of growth.
        </p>

        <div class="language-toggle">
            <span>English</span>
            <label class="switch">
                <input type="checkbox" id="languageSwitch">
                <span class="slider"></span>
            </label>
            <span>Español</span>
        </div>
    </div>

    <script>
        // --- Configuration ---
        const BASE_INTERVAL_MS = 60000; // 1 minute = 60000 ms
        const EXTRA_MONTHLY_INVESTMENT = 5.00; // $5.00 extra for comparison
        // Popout configuration
        const POPOUT_WIDTH = 1200; // 800 * 1.5 = 1200
        const POPOUT_HEIGHT = 600;
        // Font size classes map (used for dynamic styling)
        const FONT_SIZE_CLASSES = {
            1: 'size-1x',
            2: 'size-2x',
            3: 'size-3x'
        };

        // --- State Variables ---
        let regularMonthlyDeposit = 0; 
        let initialDeposit = 0;
        let stopMonths = 0;
        let monthlyRate = 0;

        let totalValue = 0;
        let principalEntered = 0;
        let months = 0;
        let intervalId = null; 
        let currentSpeedFactor = 1; 
        let popoutWindow = null; // Reference to the new window
        
        let compMonthlyDeposit = 0;
        let compTotalValue = 0;
        let compPrincipalEntered = 0;
        
        // --- TIME DRIFT TRACKING ---
        let lastUpdateTime = 0; 
        
        // --- Language Data (English / Spanish) ---
        const LANGUAGES = {
            'en': {
                'docTitle': 'Ultimate Real-Time Compound Interest Simulator',
                'popoutTitle': 'Real-Time Total Value',
                'popoutLabel': 'YOUR TOTAL VALUE:',
                'mainTitle': 'Ultimate Compound Growth Simulator 🚀',
                'label_monthlyDeposit': 'Regular Monthly Deposit ($):',
                'label_yearlyRate': 'Yearly Percentage Rate (%):',
                'advancedToggle': '▼ Advanced Settings & Projections',
                'label_initialDeposit': 'One-Time Initial Deposit ($):',
                'label_stopMonths': 'Stop Monthly Deposits After (Months):',
                'calcTitle': 'Instant Projection Calculator',
                'label_projectionMonths': 'Calculate Total Value After (Months):',
                'calculateButton': 'Calculate',
                'label_projectionResult': 'Total Projection:',
                'label_projectionTime': 'Time:',
                'startButton': 'Start Simulation',
                'stopButton': 'Stop Simulation',
                'label_speed': 'Speed:',
                'label_size': 'Size:',
                'popoutButton': 'Popout 🚀',
                'resultsTitle': 'Simulation Results',
                'label_timeElapsed': 'Time Elapsed:',
                'label_yourTotalValue': 'YOUR TOTAL VALUE:',
                'label_principal': 'Principal:',
                'label_totalInterest': 'Total Interest:',
                'label_lastInterest': 'Last Interest:',
                'compTitle': 'If you invested $5 more per month (and stopped at the same time):',
                'label_newTotalValue': 'NEW TOTAL VALUE:',
                'label_compPrincipal': 'Principal:',
                'label_compTotalInterest': 'Total Interest:',
                'label_compLastInterest': 'Last Interest:',
                'label_totalDifference': 'Total Difference:',
                'noteText': '* 1x speed means one minute in real-time equals one month of growth.'
            },
            'es': {
                'docTitle': 'Simulador de Interés Compuesto en Tiempo Real',
                'popoutTitle': 'Valor Total en Tiempo Real',
                'popoutLabel': 'SU VALOR TOTAL:',
                'mainTitle': 'Simulador de Crecimiento Compuesto Máximo 🚀',
                'label_monthlyDeposit': 'Depósito Mensual Regular ($):',
                'label_yearlyRate': 'Tasa de Porcentaje Anual (%):',
                'advancedToggle': '▼ Configuraciones Avanzadas y Proyecciones',
                'label_initialDeposit': 'Depósito Inicial Único ($):',
                'label_stopMonths': 'Detener Depósitos Mensuales Después de (Meses):',
                'calcTitle': 'Calculadora de Proyección Instantánea',
                'label_projectionMonths': 'Calcular Valor Total Después de (Meses):',
                'calculateButton': 'Calcular',
                'label_projectionResult': 'Proyección Total:',
                'label_projectionTime': 'Tiempo:',
                'startButton': 'Iniciar Simulación',
                'stopButton': 'Detener Simulación',
                'label_speed': 'Velocidad:',
                'label_size': 'Tamaño:',
                'popoutButton': 'Ventana Flotante 🚀',
                'resultsTitle': 'Resultados de la Simulación',
                'label_timeElapsed': 'Tiempo Transcurrido:',
                'label_yourTotalValue': 'SU VALOR TOTAL:',
                'label_principal': 'Principal:',
                'label_totalInterest': 'Interés Total:',
                'label_lastInterest': 'Último Interés:',
                'compTitle': 'Si invirtiera $5 más por mes (y se detuviera al mismo tiempo):',
                'label_newTotalValue': 'NUEVO VALOR TOTAL:',
                'label_compPrincipal': 'Principal:',
                'label_compTotalInterest': 'Interés Total:',
                'label_compLastInterest': 'Último Interés:',
                'label_totalDifference': 'Diferencia Total:',
                'noteText': '* La velocidad 1x significa que un minuto en tiempo real equivale a un mes de crecimiento.'
            }
        };

        // --- DOM Elements ---
        const languageSwitch = document.getElementById('languageSwitch');
        const totalValueEl = document.getElementById('totalValue');
        const timeElapsedEl = document.getElementById('timeElapsed');
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const speedButtons = document.querySelectorAll('.speed-controls button');
        const sizeButtons = document.querySelectorAll('.size-controls button'); 
        const popoutButton = document.getElementById('popoutButton');
        const regularMonthlyDepositInput = document.getElementById('initialInvestment');
        const yearlyRateInput = document.getElementById('yearlyRate');
        const initialDepositInput = document.getElementById('initialDeposit');
        const stopMonthsInput = document.getElementById('stopMonths');
        const projectionMonthsInput = document.getElementById('projectionMonths');
        const projectionResultEl = document.getElementById('projectionResult');
        const projectedTotalValueEl = document.getElementById('projectedTotalValue');
        const projectedTimeEl = document.getElementById('projectedTime');
        const principalEnteredEl = document.getElementById('principalEntered');
        const totalInterestPaidEl = document.getElementById('totalInterestPaid');
        const lastInterestPaidEl = document.getElementById('lastInterestPaid');
        const compTotalValueEl = document.getElementById('compTotalValue');
        const compPrincipalEl = document.getElementById('compPrincipal');
        const compTotalInterestEl = document.getElementById('compTotalInterest');
        const compLastInterestEl = document.getElementById('compLastInterest');
        const totalDifferenceEl = document.getElementById('totalDifference');

        // Language mapping (re-defined for clarity)
        const labeledElements = {
            'docTitle': document.getElementById('docTitle'),
            'mainTitle': document.getElementById('mainTitle'),
            'label_monthlyDeposit': document.getElementById('label_monthlyDeposit'),
            'label_yearlyRate': document.getElementById('label_yearlyRate'),
            'advancedToggle': document.getElementById('advancedToggle'),
            'label_initialDeposit': document.getElementById('label_initialDeposit'),
            'label_stopMonths': document.getElementById('label_stopMonths'),
            'calcTitle': document.getElementById('calcTitle'),
            'label_projectionMonths': document.getElementById('label_projectionMonths'),
            'calculateButton': document.getElementById('calculateButton'),
            'label_projectionResult': document.getElementById('label_projectionResult'),
            'label_projectionTime': document.getElementById('label_projectionTime'),
            'startButton': document.getElementById('startButton'),
            'stopButton': document.getElementById('stopButton'),
            'label_speed': document.getElementById('label_speed'),
            'label_size': document.getElementById('label_size'),
            'popoutButton': popoutButton,
            'resultsTitle': document.getElementById('resultsTitle'),
            'label_timeElapsed': document.getElementById('label_timeElapsed'),
            'label_yourTotalValue': document.getElementById('label_yourTotalValue'),
            'label_principal': document.getElementById('label_principal'),
            'label_totalInterest': document.getElementById('label_totalInterest'),
            'label_lastInterest': document.getElementById('label_lastInterest'),
            'compTitle': document.getElementById('compTitle'),
            'label_newTotalValue': document.getElementById('label_newTotalValue'),
            'label_compPrincipal': document.getElementById('label_compPrincipal'),
            'label_compTotalInterest': document.getElementById('label_compTotalInterest'),
            'label_compLastInterest': document.getElementById('label_compLastInterest'),
            'label_totalDifference': document.getElementById('label_totalDifference'),
            'noteText': document.getElementById('noteText')
        };
        
        // Retrieve popout styles from script tag (defined in HTML head)
        const popoutStylesScript = document.querySelector('.popout-styles-code');
        let popoutStylesContent = '';
        if (popoutStylesScript) {
            const match = popoutStylesScript.textContent.match(/const popoutStyles = `([\s\S]*?)`;/);
            if (match && match[1]) {
                popoutStylesContent = match[1].trim();
            }
        }

        // --- Helper Functions ---

        /**
         * Updates all text labels based on the selected language.
         */
        const updateLanguage = () => {
            const langKey = languageSwitch.checked ? 'es' : 'en';
            const lang = LANGUAGES[langKey];

            for (const id in labeledElements) {
                const el = labeledElements[id];
                if (el) {
                    if (id === 'docTitle') {
                        document.title = lang[id];
                    } else if (id.startsWith('label_') || id.endsWith('Title') || id.endsWith('Toggle') || id.endsWith('Text') || id === 'calcTitle') {
                        el.textContent = lang[id];
                    } else if (el.tagName === 'BUTTON' && id !== 'popoutButton') {
                        el.textContent = lang[id];
                    } else if (id === 'popoutButton') {
                         el.textContent = lang[id];
                    } else if (el.tagName === 'H1' || el.tagName === 'STRONG') {
                        el.textContent = lang[id];
                    }
                }
            }
            // Update the time display after language change too
            updateTimeDisplay();
            // Update the popout if it's open
            updatePopout();
        };

        /**
         * Formats a number as currency (e.g., $1,234.56)
         */
        const formatCurrency = (value) => {
            return '$' + value.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        };

        /**
         * Converts total months into 'X Years, Y Months' string
         */
        const formatMonthsToTime = (totalMonths) => {
            const years = Math.floor(totalMonths / 12);
            const remainingMonths = totalMonths % 12;
            
            const langKey = languageSwitch.checked ? 'es' : 'en';
            
            if (langKey === 'es') {
                return `${years} Años, ${remainingMonths} Meses`;
            }
            
            return `${years} Years, ${remainingMonths} Months`;
        };
        
        /**
         * Updates the display for time elapsed (X Years, Y Months)
         */
        const updateTimeDisplay = () => {
            timeElapsedEl.textContent = formatMonthsToTime(months);
        };
        
        /**
         * Core calculation function for a single month of compounding.
         */
        const calculateMonth = (currentValue, investment, rate) => {
            const interest = currentValue * rate;
            const newValue = currentValue + interest + investment;
            return { newValue, interest };
        };
        
        /**
         * The combined function to calculate and update a single month.
         */
        const processSingleMonth = (monthlyInvestment, compMonthlyInvestment) => {
            // --- 1. Main Calculation ---
            const mainResults = calculateMonth(totalValue, monthlyInvestment, monthlyRate);
            totalValue = mainResults.newValue;
            principalEntered += monthlyInvestment;
            const mainInterest = mainResults.interest;

            // --- 2. Comparison Calculation ---
            const compResults = calculateMonth(compTotalValue, compMonthlyInvestment, monthlyRate);
            compTotalValue = compResults.newValue;
            compPrincipalEntered += compMonthlyInvestment;
            const compInterest = compResults.interest;

            // --- 3. Update Month Count ---
            months++;
            
            return { mainInterest, compInterest };
        };

        /**
         * Updates the popout window content if it is open.
         */
        const updatePopout = () => {
            if (popoutWindow && !popoutWindow.closed) {
                const popoutDoc = popoutWindow.document;
                const langKey = languageSwitch.checked ? 'es' : 'en';
                const lang = LANGUAGES[langKey];
                
                // Update text elements
                popoutDoc.title = lang['popoutTitle'];
                popoutDoc.getElementById('popout-label').textContent = lang['popoutLabel'];
                popoutDoc.getElementById('popout-value').textContent = formatCurrency(totalValue);
                popoutDoc.getElementById('popout-time').textContent = formatMonthsToTime(months); 
            }
        };


        /**
         * Runs the core calculations and updates the display (for the real-time simulator).
         */
        const updateCalculation = () => {
            
            const now = Date.now();
            
            // Calculate expected interval time for current speed
            const expectedInterval = BASE_INTERVAL_MS / currentSpeedFactor;
            
            // Calculate how much time has actually passed
            const timePassed = now - lastUpdateTime;
            
            // Determine how many months should have elapsed (minimum 1, due to setInterval fire)
            const monthsToProcess = Math.max(1, Math.floor(timePassed / expectedInterval)); 
            
            // Get the current deposits based on simulation parameters
            const compInvestmentWithExtra = regularMonthlyDeposit + EXTRA_MONTHLY_INVESTMENT;

            let lastMainInterest = 0;
            let lastCompInterest = 0;
            
            // Loop to catch up on skipped months
            for (let i = 0; i < monthsToProcess; i++) {
                let monthlyInvestment = 0;
                let compMonthlyInvestment = 0;
                const currentMonth = months + i; 

                // Determine deposit for main investment
                if (stopMonths === 0 || currentMonth < stopMonths) {
                     monthlyInvestment = regularMonthlyDeposit;
                }

                // Determine deposit for comparison investment (also respects stopMonths)
                if (stopMonths === 0 || currentMonth < stopMonths) {
                     compMonthlyInvestment = compInvestmentWithExtra;
                } else {
                     compMonthlyInvestment = 0; 
                }

                // Run the core calculation for one month
                const { mainInterest, compInterest } = processSingleMonth(monthlyInvestment, compMonthlyInvestment);
                lastMainInterest = mainInterest;
                lastCompInterest = compInterest;
            }
            
            // --- 4. Update the Display (Main) ---
            const totalInterestPaid = totalValue - principalEntered;
            updateTimeDisplay();
            totalValueEl.textContent = formatCurrency(totalValue);
            principalEnteredEl.textContent = formatCurrency(principalEntered);
            totalInterestPaidEl.textContent = formatCurrency(totalInterestPaid);
            lastInterestPaidEl.textContent = formatCurrency(lastMainInterest); 
            
            // --- 5. Update the Display (Comparison) ---
            const compTotalInterestPaid = compTotalValue - compPrincipalEntered;
            const totalDifference = compTotalValue - totalValue;
            
            compTotalValueEl.textContent = formatCurrency(compTotalValue); 
            compPrincipalEl.textContent = formatCurrency(compPrincipalEntered);
            compTotalInterestEl.textContent = formatCurrency(compTotalInterestPaid);
            compLastInterestEl.textContent = formatCurrency(lastCompInterest);
            totalDifferenceEl.textContent = formatCurrency(totalDifference);
            
            // --- 6. Update Popout Window ---
            updatePopout();
            
            // Update last update time for next drift check
            lastUpdateTime = now; 
        };

        /**
         * Clears the existing interval and sets a new one based on the current speed.
         */
        const resetInterval = () => {
            if (intervalId) {
                clearInterval(intervalId);
            }
            
            // Interval time is the base time divided by the speed factor
            const intervalDuration = BASE_INTERVAL_MS / currentSpeedFactor;
            
            // Set the last update time to now before the first calculation
            lastUpdateTime = Date.now();
            
            // Run the first update immediately
            updateCalculation(); 
            
            intervalId = setInterval(updateCalculation, intervalDuration); 
        };

        /**
         * Reads input values and validates them. Returns an object of parsed values or false.
         */
        const getAndValidateInputs = () => {
             const regular = parseFloat(regularMonthlyDepositInput.value);
            const rate = parseFloat(yearlyRateInput.value);
            const initial = parseFloat(initialDepositInput.value);
            const stop = parseInt(stopMonthsInput.value);

            if (isNaN(regular) || regular < 0 || isNaN(initial) || initial < 0 || isNaN(rate) || rate < 0 || isNaN(stop) || stop < 0) {
                alert("Please ensure all investment and rate fields contain valid non-negative numbers.");
                return false;
            }
            
            const monthlyRate = (rate / 100) / 12;

            return { regular, initial, rate, stop, monthlyRate };
        };


        /**
         * Initializes and starts the real-time simulation
         */
        const startSimulation = () => {
            // Stop any existing simulation
            if (intervalId) {
                stopSimulation();
            }

            const inputs = getAndValidateInputs();
            if (!inputs) return;

            // 1. Assign inputs to state variables
            ({ regular: regularMonthlyDeposit, initial: initialDeposit, stop: stopMonths, monthlyRate } = inputs);

            // 2. Reset state variables
            totalValue = initialDeposit;
            principalEntered = initialDeposit;
            compTotalValue = initialDeposit; 
            compPrincipalEntered = initialDeposit;
            months = 0;
            compMonthlyDeposit = regularMonthlyDeposit + EXTRA_MONTHLY_INVESTMENT; 

            // 3. Disable/Enable Controls and inputs
            regularMonthlyDepositInput.disabled = true;
            yearlyRateInput.disabled = true;
            initialDepositInput.disabled = true;
            stopMonthsInput.disabled = true;
            startButton.disabled = true;
            stopButton.disabled = false;
            
            speedButtons.forEach(btn => btn.disabled = false); 
            
            projectionResultEl.style.display = 'none';

            // 4. Start the simulation and immediately run the first calculation
            resetInterval();
        };

        /**
         * Stops the real-time simulation interval
         */
        const stopSimulation = () => {
            if (intervalId) {
                clearInterval(intervalId);
                intervalId = null;

                // Re-enable inputs and start button
                regularMonthlyDepositInput.disabled = false;
                yearlyRateInput.disabled = false;
                initialDepositInput.disabled = false;
                stopMonthsInput.disabled = false;
                startButton.disabled = false;
                stopButton.disabled = true;
            }
        };

        /**
         * Handles the instant "Calculate" button click (simplified, logic is now external)
         */
        const handleProjectionCalculation = () => {
            const inputs = getAndValidateInputs();
            if (!inputs) return;
            
            const projectionMonths = parseInt(projectionMonthsInput.value);
            if (isNaN(projectionMonths) || projectionMonths <= 0) {
                alert("Please enter a valid number of months for the calculation.");
                return;
            }

            // Simple calculation function 
            const calculateProjection = (totalMonths, initial, regular, rate, stopAtMonth, isComparison = false) => {
                let currentValue = initial;
                let principal = initial;
                let lastInterest = 0;
                const regularInvestment = isComparison ? regular + EXTRA_MONTHLY_INVESTMENT : regular;

                for (let m = 0; m < totalMonths; m++) {
                    let monthlyInvestment = 0;
                    if (stopAtMonth === 0 || m < stopAtMonth) {
                        monthlyInvestment = regularInvestment;
                    }
                    
                    const { newValue, interest } = calculateMonth(currentValue, monthlyInvestment, rate);
                    currentValue = newValue;
                    principal += monthlyInvestment;
                    lastInterest = interest;
                }
                return { finalValue: currentValue, finalPrincipal: principal, finalInterest: lastInterest };
            };
            
            // Calculate the projection based on all current inputs
            const projection = calculateProjection(
                projectionMonths,
                inputs.initial,
                inputs.regular,
                inputs.monthlyRate,
                inputs.stop,
                false
            );

            // Update the display
            projectedTotalValueEl.textContent = formatCurrency(projection.finalValue);
            projectedTimeEl.textContent = formatMonthsToTime(projectionMonths);
            projectionResultEl.style.display = 'block';
        };

        /**
         * Handles speed button clicks
         */
        const setSpeed = (event) => {
            if (startButton.disabled === false) return; 

            const newSpeed = parseInt(event.target.dataset.speed);
            if (newSpeed !== currentSpeedFactor) {
                currentSpeedFactor = newSpeed;
                speedButtons.forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');
                // The crucial line: reset the interval to take effect immediately
                resetInterval(); 
            }
        };

        /**
         * Handles font size button clicks
         */
        const setFontSize = (event) => {
            const newSize = parseInt(event.target.dataset.size);
            
            totalValueEl.classList.remove(FONT_SIZE_CLASSES[1], FONT_SIZE_CLASSES[2], FONT_SIZE_CLASSES[3]);
            totalValueEl.classList.add(FONT_SIZE_CLASSES[newSize]);
            
            sizeButtons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        };
        
        /**
         * Creates and manages the popout window.
         */
        const togglePopout = () => {
            if (popoutWindow && !popoutWindow.closed) {
                popoutWindow.close();
                popoutWindow = null;
                return;
            }
            
            const langKey = languageSwitch.checked ? 'es' : 'en';
            const lang = LANGUAGES[langKey];
            
            // UPDATED: Use the new POPOUT_WIDTH constant (1200px)
            const features = `width=${POPOUT_WIDTH},height=${POPOUT_HEIGHT},resizable=yes,scrollbars=no`;
            
            popoutWindow = window.open("", "TotalValuePopout", features);
            
            if (popoutWindow) {
                const popoutDoc = popoutWindow.document;
                
                // Write the initial HTML content
                popoutDoc.write(`
                    <html>
                        <head>
                            <title>${lang['popoutTitle']}</title>
                            <style>${popoutStylesContent}</style>
                        </head>
                        <body>
                            <div id="popout-container">
                                <div id="popout-label">${lang['popoutLabel']}</div>
                                <div id="popout-value">${formatCurrency(totalValue)}</div>
                                <div id="popout-time">${formatMonthsToTime(months)}</div>
                            </div>
                        </body>
                    </html>
                `);
                popoutDoc.close();
                
                // Set up event to null the reference when the popout is closed by the user
                popoutWindow.addEventListener('unload', () => {
                    popoutWindow = null;
                });
                
                // Run an immediate update to ensure the popout is current right after creation
                updatePopout();
            }
        };


        // --- Event Listeners ---
        startButton.addEventListener('click', startSimulation);
        stopButton.addEventListener('click', stopSimulation);
        document.getElementById('calculateButton').addEventListener('click', handleProjectionCalculation);
        languageSwitch.addEventListener('change', updateLanguage); 
        popoutButton.addEventListener('click', togglePopout); 
        
        speedButtons.forEach(button => {
            button.addEventListener('click', setSpeed);
        });

        sizeButtons.forEach(button => {
            button.addEventListener('click', setFontSize);
        });


        // Initial setup
        speedButtons.forEach(btn => btn.disabled = true);
        updateLanguage();
        totalValueEl.classList.add(FONT_SIZE_CLASSES[1]); 
    </script>
</body>

</html>
