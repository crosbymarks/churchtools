<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Daily Rosary Mystery Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Force full viewport height */
        body {
            font-family: 'Inter', sans-serif;
            height: 100dvh;
            width: 100vw;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f7f3f1;
            overflow: hidden;
            overscroll-behavior: none;
        }
        .card { box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .mystery-box { transition: all 0.2s ease-in-out; cursor: pointer; border: 2px solid transparent; }
        .mystery-box:hover { border-color: #4f46e5; transform: translateY(-2px); }
        .grayscale { filter: grayscale(100%); }
        .full-color { filter: none; }

        /* Modal Layout */
        .modal {
            position: fixed; top: 0; left: 0; 
            width: 100%; height: 100dvh;
            background-color: #f7f3f1; z-index: 50;
            opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
            display: flex; flex-direction: column;
        }
        .modal.active { opacity: 1; visibility: visible; }
        
        /* IMAGE CONTAINER */
        .image-container-wrapper {
            width: 100%;
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            position: relative;
            display: flex; 
            align-items: center;
            justify-content: center; 
            flex-shrink: 1;
            transition: all 0.4s ease;
            cursor: zoom-in;
            overflow: hidden; 
        }

        .image-container-wrapper.zoomed {
            cursor: zoom-out;
            overflow: auto; 
            display: block; 
        }

        .contemplation-image {
            max-width: 100%; 
            max-height: 100%; 
            object-fit: contain;
            transition: transform 0.3s ease;
            margin: auto;
            display: block;
        }

        .image-container-wrapper.zoomed .contemplation-image {
            max-width: none; 
            max-height: none;
            width: 200%; 
            height: auto;
            margin: 0; 
        }

        /* DYNAMIC LAYOUT SIZING */
        .view-text-visible .image-container-wrapper { height: 50%; }
        .view-text-hidden .image-container-wrapper { height: 75%; }
        
        /* TEXT BOX TRANSITIONS */
        #modal-text-area { 
            overflow-y: hidden; 
            position: relative; 
            transition: height 0.4s ease, opacity 0.3s ease, padding 0.4s ease, margin 0.4s ease;
            will-change: height, opacity;
        }

        .view-text-hidden #modal-text-area {
            height: 1px !important; 
            opacity: 0;
            padding-top: 0;
            padding-bottom: 0;
            margin: 0;
            pointer-events: none;
            overflow: hidden;
        }

        /* Beads */
        .bead {
            display: inline-block; width: 18px; height: 18px; 
            border-radius: 50%; margin: 3px; flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: all 0.2s ease;
        }
        .red-bead { background-color: #ef4444; }
        .white-bead { background-color: #ffffff; border: 1px solid #d1d5db; }
        .bead.current { transform: scale(1.3); box-shadow: 0 0 0 4px #a78bfa; border-color: #a78bfa; }
        
        /* Text Animation */
        @keyframes prayerScroll {
            0% { transform: translateY(var(--start-position)); }
            100% { transform: translateY(var(--end-position)); }
        }
        #dynamic-prayer-content {
            position: absolute; width: 100%; padding: 0 24px; top: 0; left: 0;
            transform: translateY(var(--start-position, 0)); 
            will-change: transform; 
        }

        #settings-panel.active { transform: translateY(0); }
        .control-btn {
            padding: 0.75rem 1rem; border-radius: 9999px; font-weight: 600;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); transition: all 0.2s ease;
            font-size: 0.95rem; white-space: nowrap;
        }
        #list-view-container { height: 100%; overflow-y: auto; -webkit-overflow-scrolling: touch; }
    </style>
</head>
<body class="p-0 m-0">

    <audio id="background-music" loop playsinline>
        <source src="instrumental-piano-christian-worship-of-jesus-301250.mp3" type="audio/mpeg">
    </audio>
    <audio id="sfx-water" preload="auto" src="water-drop-3-84577.mp3"></audio>
    <audio id="sfx-bell" preload="auto" src="https://upload.wikimedia.org/wikipedia/commons/2/2a/Glocke.ogg"></audio>
    <audio id="sfx-chime" preload="auto" src="WindChime-Short.mp3"></audio>
    <audio id="sfx-page" preload="auto" src="page-flip1-178322.mp3"></audio>

    <div id="settings-panel" class="fixed inset-x-0 top-0 transform -translate-y-full transition-transform duration-300 z-50 bg-white shadow-xl p-6 rounded-b-xl max-w-lg mx-auto">
        <div class="flex justify-between items-center mb-6 border-b pb-4">
            <h3 class="text-2xl font-bold text-indigo-700" id="lbl-settings-title">App Settings</h3>
            <button onclick="toggleSettingsPanel()" class="p-2 text-gray-500 hover:text-gray-900 rounded-full hover:bg-gray-100 transition">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </div>
        <div class="space-y-4">
            <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg">
                <label class="font-medium text-gray-700" id="lbl-language">Language</label>
                <select id="language-select" onchange="updateLanguage(this.value)" class="py-2 text-sm rounded-lg border-gray-300">
                    <option value="en">English</option>
                    <option value="es">Español</option>
                </select>
            </div>
            <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg">
                <label class="font-medium text-gray-700" id="lbl-structure">Rosary Structure</label>
                <select id="structure-select" onchange="updateRosaryStructure(this.value)" class="py-2 text-sm rounded-lg border-gray-300">
                    <option value="daily" id="opt-daily">Daily Mystery</option>
                    <option value="full" id="opt-full">Full Rosary</option>
                </select>
            </div>
            <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg">
                <label class="font-medium text-gray-700" id="lbl-mode">Default Mode</label>
                <select id="mode-select" onchange="updateDefaultMode(this.value)" class="py-2 text-sm rounded-lg border-gray-300">
                    <option value="manual" id="opt-manual">Manual</option>
                    <option value="auto" id="opt-auto">Auto Play</option>
                </select>
            </div>
            <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg">
                <label class="font-medium text-gray-700" id="lbl-pace">Contemplation Pace</label>
                <select id="speed-select" onchange="updateSpeed(this.value)" class="py-2 text-sm rounded-lg border-gray-300">
                    <option value="1">1x</option>
                    <option value="1.25">1.25x</option>
                    <option value="1.5">1.5x</option>
                    <option value="2">2x</option>
                </select>
            </div>
            <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg">
                <label class="font-medium text-gray-700" id="lbl-textsize">Text Size</label>
                <select id="size-select" onchange="updateTextSize(this.value)" class="py-2 text-sm rounded-lg border-gray-300">
                    <option value="medium" id="opt-med">Medium</option>
                    <option value="small" id="opt-small">Small</option>
                    <option value="large" id="opt-large">Large</option>
                </select>
            </div>
            <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg">
                <label class="font-medium text-gray-700" id="lbl-music">Background Music</label>
                <select id="music-select" onchange="updateMusicVolume(this.value)" class="py-2 text-sm rounded-lg border-gray-300">
                    <option value="off" id="opt-off">Off</option>
                    <option value="soft" id="opt-soft">Soft</option>
                    <option value="loud" id="opt-loud">Loud</option>
                </select>
            </div>
            <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg">
                <label class="font-medium text-gray-700" id="lbl-sfx">Sound Effects</label>
                <input type="checkbox" id="sfx-checkbox" onchange="updateSfxEnabled(this.checked)" class="h-6 w-6 text-indigo-600 rounded cursor-pointer">
            </div>
            <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg">
                <label class="font-medium text-gray-700" id="lbl-autocontinue">Auto Continue</label>
                <input type="checkbox" id="auto-continue-checkbox" onchange="updateAutoContinue(this.checked)" class="h-6 w-6 text-indigo-600 rounded cursor-pointer">
            </div>
            <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg">
                <label class="font-medium text-gray-700" id="lbl-showtext">Show Prayer Text</label>
                <input type="checkbox" id="show-text-checkbox" onchange="toggleTextVisibilityFromSettings(this.checked)" class="h-6 w-6 text-indigo-600 rounded cursor-pointer">
            </div>
        </div>
    </div>

    <div id="list-view-container" class="w-full h-full p-4">
        <div id="list-view" class="card bg-white w-full max-w-lg mx-auto rounded-xl p-6 md:p-8 transition-all duration-300 mb-8">
            <header class="flex justify-between items-start mb-6">
                <button onclick="toggleSettingsPanel()" class="p-2 text-gray-600 hover:text-indigo-600 rounded-full transition mt-2">
                    <span class="text-2xl font-extrabold">&#9881;</span>
                </button>
                <div class="text-center flex-grow mx-4">
                    <h1 class="text-3xl font-bold text-gray-800 mb-1"><span class="text-indigo-600">Visio Divina</span> Rosary</h1>
                    <p class="text-base text-gray-500" id="lbl-subtitle">Contemplation through sacred images.</p>
                </div>
                <button class="p-2 mt-2 invisible"><span class="text-2xl font-extrabold">&#9881;</span></button>
            </header>

            <div class="text-center p-4 bg-indigo-50 rounded-lg border-2 border-indigo-200 mb-6">
                <p class="text-sm font-semibold text-indigo-700 uppercase tracking-wider mb-2" id="current-day-text">Loading...</p>
                <h2 id="mystery-group-name" class="text-3xl sm:text-4xl leading-tight font-extrabold text-indigo-800">Loading...</h2>
            </div>
            
            <div class="flex justify-between items-center border-b pb-2 mb-4">
                <h3 class="text-lg font-semibold text-gray-700" id="mystery-list-title">The Rosary Contemplations</h3>
                <button id="reset-button" onclick="window.confirmReset()" class="px-3 py-1 text-sm bg-red-100 text-red-600 rounded-full hover:bg-red-200 transition font-medium">Reset Day</button>
            </div>
            
            <div id="daily-mysteries-container" class="space-y-4"></div>
            
            <div class="mt-8 pt-4 border-t border-gray-200">
                <button onclick="document.getElementById('cycle-list-wrapper').classList.toggle('hidden'); if(!document.getElementById('cycle-list-wrapper').classList.contains('hidden')) populateCycleList(realCurrentDayIndex, selectedDayIndex);" class="w-full text-sm text-indigo-600 hover:text-indigo-800 font-medium py-2" id="btn-showcycle">Show/Hide Full Weekly Cycle</button>
                <div id="cycle-list-wrapper" class="hidden">
                    <p class="text-sm font-semibold text-gray-600 mt-4 mb-2" id="lbl-selectday">Select a Day (Actual: *)</p>
                    <div id="cycle-list" class="space-y-1 text-sm"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="contemplation-view" class="modal view-text-visible">
        
        <div class="p-2 flex justify-end items-center bg-white shadow-md flex-shrink-0 relative h-12 z-20">
            <h3 id="modal-top-title" class="absolute inset-x-8 text-center text-lg font-bold text-gray-800 truncate"></h3>
            <button onclick="finishSession(false)" class="p-2 text-gray-500 hover:text-gray-900 rounded-full hover:bg-gray-100 transition z-10">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </div>

        <div class="flex-1 flex flex-col items-center justify-start p-2 overflow-y-hidden relative w-full max-w-xl mx-auto">
            
            <div id="rose-container" class="flex flex-wrap justify-center w-full mb-1 py-1 min-h-[30px] flex-shrink-0 items-center">
            </div>

            <div id="image-wrapper" class="image-container-wrapper w-full bg-white rounded-xl shadow-xl p-1 mb-2 flex-shrink-1 overflow-hidden relative" onclick="toggleZoom()">
                <img id="modal-image" class="contemplation-image rounded-lg full-color" alt="Contemplation Image" 
                     onerror="this.onerror=null; this.src='https://placehold.co/800x400/cccccc/000000?text=Image+Load+Error';">
                
                <div id="zoom-hint" class="absolute inset-0 flex items-center justify-center pointer-events-none opacity-0 transition-opacity duration-500">
                    <span class="bg-black/50 text-white text-xs px-2 py-1 rounded" id="lbl-zoomhint">Tap to Zoom</span>
                </div>
            </div>
            
            <div id="prayer-display-wrapper" class="w-full flex-shrink-0 transition-all duration-300">
                <div id="prayer-title-bar" class="w-full p-2 mb-1 bg-indigo-100 rounded-lg shadow-inner flex justify-between items-center relative">
                    <div id="mystery-badge" class="w-8 h-8 rounded-full bg-indigo-800 text-white flex items-center justify-center font-bold text-sm shadow-md transition-opacity duration-300 opacity-0">1</div>
                    <h4 id="current-prayer-title" class="text-lg font-semibold text-indigo-800 text-center flex-grow mx-2 truncate">Contemplation</h4>
                    <button onclick="toggleTextVisibility()" id="on-screen-toggle-btn" class="text-indigo-600 hover:text-indigo-900 p-1 w-8 flex justify-center" onclick="event.stopPropagation()">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 transition-transform duration-300" id="toggle-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
                    </button>
                </div>
                
                <div id="modal-text-area" class="w-full bg-white rounded-xl shadow-lg p-4 h-28 relative transition-all duration-300 overflow-hidden mb-2">
                    <div id="dynamic-prayer-content" class="text-base text-gray-700 italic text-center"></div>
                    <div id="scroll-instruction" class="absolute inset-0 flex items-center justify-center opacity-0 transition-opacity duration-500 pointer-events-none">
                        <span class="bg-white/90 px-3 py-1 rounded-full text-indigo-600 font-bold text-xs shadow-md border border-indigo-100 backdrop-blur-sm" id="lbl-instruction">Press Play or Next to continue</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex-shrink-0 w-full bg-[#f7f3f1] z-30 p-3 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
            <div class="flex justify-center flex-wrap gap-3 w-full max-w-xl mx-auto">
                <button id="play-pause-btn" onclick="togglePlayPause()" class="control-btn bg-indigo-600 text-white hover:bg-indigo-700 w-24">Play</button>
                <button id="next-btn" onclick="userNextStep()" class="control-btn bg-gray-500 text-white hover:bg-gray-600 w-24">Next</button>
                <button id="finish-section-btn" onclick="finishCurrentSection()" class="control-btn bg-red-500 text-white hover:bg-red-600 flex-grow">Finish Mystery</button>
            </div>
        </div>
    </div>
    
    <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-xl p-6 shadow-2xl max-w-sm w-full text-center">
            <h3 id="modal-title" class="text-xl font-bold text-gray-800 mb-4"></h3>
            <p id="modal-message" class="text-gray-600 mb-6"></p>
            <div class="flex justify-center space-x-4">
                <button id="modal-confirm" class="px-4 py-2 bg-red-500 text-white hover:bg-red-600 rounded-lg transition shadow">Confirm</button>
                <button id="modal-cancel" class="px-4 py-2 bg-gray-200 text-gray-800 hover:bg-gray-300 rounded-lg transition shadow">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // --- TRANSLATION DATA ---
        const translations = {
            en: {
                ui: {
                    settings: "App Settings",
                    language: "Language",
                    structure: "Rosary Structure",
                    daily: "Daily Mystery",
                    full: "Full Rosary",
                    mode: "Default Mode",
                    manual: "Manual",
                    auto: "Auto Play",
                    pace: "Contemplation Pace",
                    textsize: "Text Size",
                    small: "Small",
                    medium: "Medium",
                    large: "Large",
                    bgmusic: "Background Music",
                    off: "Off",
                    soft: "Soft",
                    loud: "Loud",
                    sfx: "Sound Effects",
                    autocontinue: "Auto Continue",
                    showtext: "Show Prayer Text",
                    subtitle: "Contemplation through sacred images.",
                    reset: "Reset Day",
                    cycle: "Show/Hide Full Weekly Cycle",
                    selectday: "Select a Day (Actual: *)",
                    play: "Play",
                    pause: "Pause",
                    next: "Next",
                    finish: "Finish Mystery",
                    finishRosary: "Finish Rosary",
                    skipIntro: "Skip Intro",
                    completed: "✓ Completed",
                    zoomHint: "Tap to Zoom",
                    instruction: "Press Play or Next to continue",
                    today: "Today",
                    viewing: "Viewing",
                    modalResetTitle: "Reset Progress",
                    modalResetMsg: "Clear all progress for today?",
                    confirm: "Confirm",
                    cancel: "Cancel",
                    mysteryLabel: "Mystery",
                    introLabel: "I. Opening",
                    conclLabel: "VII. Closing",
                    fullSeq: "Full Rosary Sequence",
                    dailySeq: "Daily Mysteries"
                },
                days: ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"],
                mysteries: {
                    joyful: "Joyful Mysteries",
                    sorrowful: "Sorrowful Mysteries",
                    glorious: "Glorious Mysteries",
                    luminous: "Luminous Mysteries",
                    titles: {
                        joyful: ["The Annunciation", "The Visitation", "The Nativity", "The Presentation", "The Finding in the Temple"],
                        sorrowful: ["The Agony in the Garden", "The Scourging at the Pillar", "The Crowning with Thorns", "The Carrying of the Cross", "The Crucifixion"],
                        glorious: ["The Resurrection", "The Ascension", "The Descent of the Holy Spirit", "The Assumption", "The Coronation of Mary"],
                        luminous: ["The Baptism of Jesus", "The Wedding at Cana", "The Proclamation of the Kingdom", "The Transfiguration", "The Institution of the Eucharist"],
                        special: { intro: "Introduction", conclusion: "Conclusion" }
                    }
                },
                prayers: {
                    sotc: { title: "Sign of the Cross", text: "In the name of the Father, and of the Son, and of the Holy Spirit. Amen." },
                    ac: { title: "The Apostles' Creed", text: "I believe in God, the Father Almighty, Creator of heaven and earth; and in Jesus Christ, His only Son, our Lord: Who was conceived by the Holy Spirit, born of the Virgin Mary, suffered under Pontius Pilate, was crucified, died, and was buried. He descended into hell; the third day He arose again from the dead. He ascended into heaven, sitteth at the right hand of God the Father Almighty; from thence He shall come to judge the living and the dead. I believe in the Holy Spirit, the holy Catholic Church, the communion of Saints, the forgiveness of sins, the resurrection of the body, and life everlasting. Amen." },
                    of: { title: "The Our Father", text: "Our Father, Who art in heaven, Hallowed be Thy Name. Thy Kingdom come, Thy Will be done, on Earth as it is in Heaven. Give us this day our daily bread, and forgive us our trespasses, as we forgive those who trespass against us. And lead us not into temptation, but deliver us from evil. Amen." },
                    hm: { title: "Hail Mary", text: "Hail Mary, full of grace, the Lord is with thee. Blessed art thou amongst women, and blessed is the fruit of thy womb, Jesus. Holy Mary, Mother of God, pray for us sinners, now and at the hour of our death. Amen." },
                    gb: { title: "Glory Be", text: "Glory be to the Father, and to the Son, and to the Holy Spirit. As it was in the beginning, is now, and ever shall be, world without end. Amen." },
                    gbf: { title: "Glory Be & Fatima", text: "Glory be to the Father, and to the Son, and to the Holy Spirit. As it was in the beginning, is now, and ever shall be, world without end. Amen. O my Jesus, forgive us our sins, save us from the fires of hell, lead all souls to Heaven, especially those in most need of Thy mercy." },
                    hhq: { title: "Hail Holy Queen", text: "Hail, holy Queen, Mother of Mercy! Our life, our sweetness, and our hope! To thee do we cry, poor banished children of Eve; to thee do we send up our sighs, mourning and weeping in this valley of tears. Turn then, most gracious advocate, thine eyes of mercy toward us; and after this, our exile, show unto us the blessed fruit of thy womb, Jesus. O clement, O loving, O sweet Virgin Mary. Pray for us, O Holy Mother of God, that we may be made worthy of the promises of Christ. Amen." },
                    ogws: { title: "O God, Whose", text: "O God, whose only begotten Son, by His life, death, and resurrection, has purchased for us the rewards of eternal life, grant, we beseech Thee, that meditating upon these mysteries of the most holy Rosary of the Blessed Virgin Mary, we may imitate what they contain and obtain what they promise, through the same Christ our Lord. Amen." },
                    contemplation: { title: "Contemplation", text: "Gaze upon this image. What emotion does it evoke? What detail catches your attention? How does it connect you to the life of Christ or Mary?" }
                }
            },
            es: {
                ui: {
                    settings: "Configuración",
                    language: "Idioma",
                    structure: "Estructura del Rosario",
                    daily: "Misterio Diario",
                    full: "Rosario Completo",
                    mode: "Modo Predeterminado",
                    manual: "Manual",
                    auto: "Automático",
                    pace: "Velocidad de Contemplación",
                    textsize: "Tamaño del Texto",
                    small: "Pequeño",
                    medium: "Medio",
                    large: "Grande",
                    bgmusic: "Música de Fondo",
                    off: "Apagado",
                    soft: "Suave",
                    loud: "Alto",
                    sfx: "Efectos de Sonido",
                    autocontinue: "Continuar Automáticamente",
                    showtext: "Mostrar Texto",
                    subtitle: "Contemplación a través de imágenes sagradas.",
                    reset: "Reiniciar Día",
                    cycle: "Mostrar/Ocultar Ciclo Semanal",
                    selectday: "Seleccionar Día (Actual: *)",
                    play: "Reproducir",
                    pause: "Pausa",
                    next: "Siguiente",
                    finish: "Terminar Misterio",
                    finishRosary: "Terminar Rosario",
                    skipIntro: "Saltar Intro",
                    completed: "✓ Completado",
                    zoomHint: "Toca para Ampliar",
                    instruction: "Presiona Reproducir o Siguiente para continuar",
                    today: "Hoy",
                    viewing: "Viendo",
                    modalResetTitle: "Reiniciar Progreso",
                    modalResetMsg: "¿Borrar todo el progreso de hoy?",
                    confirm: "Confirmar",
                    cancel: "Cancelar",
                    mysteryLabel: "Misterio",
                    introLabel: "I. Apertura",
                    conclLabel: "VII. Cierre",
                    fullSeq: "Secuencia Completa",
                    dailySeq: "Misterios Diarios"
                },
                days: ["Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado"],
                mysteries: {
                    joyful: "Misterios Gozosos",
                    sorrowful: "Misterios Dolorosos",
                    glorious: "Misterios Gloriosos",
                    luminous: "Misterios Luminosos",
                    titles: {
                        joyful: ["La Encarnación", "La Visitación", "El Nacimiento", "La Presentación", "El Niño Perdido y Hallado"],
                        sorrowful: ["La Oración en el Huerto", "La Flagelación", "La Coronación de Espinas", "Jesús con la Cruz a Cuestas", "La Crucifixión"],
                        glorious: ["La Resurrección", "La Ascensión", "La Venida del Espíritu Santo", "La Asunción", "La Coronación de María"],
                        luminous: ["El Bautismo de Jesús", "Las Bodas de Caná", "El Anuncio del Reino", "La Transfiguración", "La Institución de la Eucaristía"],
                        special: { intro: "Introducción", conclusion: "Conclusión" }
                    }
                },
                prayers: {
                    sotc: { title: "La Señal de la Cruz", text: "En el nombre del Padre, y del Hijo, y del Espíritu Santo. Amén." },
                    ac: { title: "El Credo", text: "Creo en Dios, Padre Todopoderoso, Creador del cielo y de la tierra. Creo en Jesucristo, su único Hijo, Nuestro Señor, que fue concebido por obra y gracia del Espíritu Santo, nació de Santa María Virgen, padeció bajo el poder de Poncio Pilato, fue crucificado, muerto y sepultado, descendió a los infiernos, al tercer día resucitó de entre los muertos, subió a los cielos y está sentado a la derecha de Dios, Padre todopoderoso. Desde allí ha de venir a juzgar a vivos y muertos. Creo en el Espíritu Santo, la santa Iglesia católica, la comunión de los santos, el perdón de los pecados, la resurrección de la carne y la vida eterna. Amén." },
                    of: { title: "Padre Nuestro", text: "Padre nuestro, que estás en el cielo, santificado sea tu Nombre; venga a nosotros tu reino; hágase tu voluntad en la tierra como en el cielo. Danos hoy nuestro pan de cada día; perdona nuestras ofensas, como también nosotros perdonamos a los que nos ofenden; no nos dejes caer en la tentación, y líbranos del mal. Amén." },
                    hm: { title: "Ave María", text: "Dios te salve, María, llena eres de gracia; el Señor es contigo. Bendita tú eres entre todas las mujeres, y bendito es el fruto de tu vientre, Jesús. Santa María, Madre de Dios, ruega por nosotros, pecadores, ahora y en la hora de nuestra muerte. Amén." },
                    gb: { title: "Gloria", text: "Gloria al Padre, y al Hijo, y al Espíritu Santo. Como era en el principio, ahora y siempre, por los siglos de los siglos. Amén." },
                    gbf: { title: "Gloria y Jaculatoria", text: "Gloria al Padre, y al Hijo, y al Espíritu Santo. Como era en el principio, ahora y siempre, por los siglos de los siglos. Amén. Oh Jesús mío, perdona nuestros pecados, líbranos del fuego del infierno, lleva al cielo a todas las almas, especialmente a las más necesitadas de tu misericordia." },
                    hhq: { title: "La Salve", text: "Dios te salve, Reina y Madre de misericordia, vida, dulzura y esperanza nuestra; Dios te salve. A Ti llamamos los desterrados hijos de Eva; a Ti suspiramos, gimiendo y llorando, en este valle de lágrimas. Ea, pues, Señora, abogada nuestra, vuelve a nosotros esos tus ojos misericordiosos; y después de este destierro muéstranos a Jesús, fruto bendito de tu vientre. ¡Oh clementísima, oh piadosa, oh dulce Virgen María! Ruega por nosotros, Santa Madre de Dios, para que seamos dignos de alcanzar las promesas de Nuestro Señor Jesucristo. Amén." },
                    ogws: { title: "Oración Final", text: "Oh Dios, cuyo Unigénito Hijo, con su vida, muerte y resurrección, nos ha comprado la recompensa de la vida eterna; concédenos, te rogamos, que meditando estos misterios del Santísimo Rosario de la Bienaventurada Virgen María, imitemos lo que contienen y alcancemos lo que prometen. Por el mismo Jesucristo nuestro Señor. Amén." },
                    contemplation: { title: "Contemplación", text: "Contempla esta imagen. ¿Qué emoción te evoca? ¿Qué detalle llama tu atención? ¿Cómo te conecta con la vida de Cristo o María?" }
                }
            }
        };

        // --- CONSTANTS ---
        const imageAssets = {
            joyful: ["https://upload.wikimedia.org/wikipedia/commons/0/0e/Fra_Angelico_-_The_Annunciation_-_WGA00555.jpg", "https://upload.wikimedia.org/wikipedia/commons/d/dc/La_Visitation_avec_Marie-Jacobie_et_Marie-Salom%C3%A9_-_Domenico_Ghirlandaio_-_Mus%C3%A9e_du_Louvre_Peintures_INV_297_%3B_MR_240.jpg", "https://upload.wikimedia.org/wikipedia/commons/6/64/Geertgen_tot_Sint_Jans%2C_The_Nativity_at_Night%2C_c_1490.jpg", "https://upload.wikimedia.org/wikipedia/commons/f/f7/Rembrandt_-_Circumcision_-_WGA19111.jpg", "https://upload.wikimedia.org/wikipedia/commons/5/51/Cima_da_Conegliano_Christ_among_the_doctors.jpg"],
            sorrowful: ["https://upload.wikimedia.org/wikipedia/commons/1/10/Bellini%2CGiovanni_-_Agony_in_the_Garden_-_National_Gallery.jpg", "https://upload.wikimedia.org/wikipedia/commons/1/11/Piero_-_The_Flagellation.jpg", "https://upload.wikimedia.org/wikipedia/commons/5/52/Caravaggio%2C_Crowning_of_Thorns.jpg", "https://upload.wikimedia.org/wikipedia/commons/5/5d/Hieronymus_Bosch_-_Christ_Carrying_the_Cross_-_WGA2498.jpg", "https://upload.wikimedia.org/wikipedia/commons/d/d3/Lotto%2C_crocifissione_01.jpg"],
            glorious: ["https://upload.wikimedia.org/wikipedia/commons/c/c2/Resurrection.JPG", "https://upload.wikimedia.org/wikipedia/commons/0/01/Jacopo_Tintoretto_-_The_Ascension_-_WGA22570.jpg", "https://upload.wikimedia.org/wikipedia/commons/5/5a/Titian_-_The_Descent_of_the_Holy_Ghost_-_WGA22768.jpg", "https://upload.wikimedia.org/wikipedia/commons/9/9e/Tizian_041.jpg", "https://upload.wikimedia.org/wikipedia/commons/b/b5/Diego_Vel%C3%A1zquez_-_Coronation_of_the_Virgin_-_Prado.jpg"],
            luminous: ["https://upload.wikimedia.org/wikipedia/commons/5/5a/Piero_della_Francesca_-_Baptism_of_Christ_-_WGA17595.jpg", "https://upload.wikimedia.org/wikipedia/commons/2/21/Paolo_Veronese%2C_The_Wedding_at_Cana.JPG", "https://upload.wikimedia.org/wikipedia/commons/9/96/Bloch-SermonOnTheMount.jpg", "https://upload.wikimedia.org/wikipedia/commons/5/51/Transfiguration_Raphael.jpg", "https://upload.wikimedia.org/wikipedia/commons/0/08/Leonardo_da_Vinci_%281452-1519%29_-_The_Last_Apper_%281495-1498%29.jpg"],
            special: { intro: "https://upload.wikimedia.org/wikipedia/commons/4/4d/Rosary_2006-01-16.jpg", conclusion: "https://upload.wikimedia.org/wikipedia/commons/4/4e/Antonio_de_Pereda_y_Salgado_-_The_Holy_Trinity_-_WGA17176.jpg" }
        };

        const mysterySchedule = [
            { id: "glorious" }, // Sun
            { id: "joyful" },   // Mon
            { id: "sorrowful" },// Tue
            { id: "glorious" }, // Wed
            { id: "luminous" }, // Thu
            { id: "sorrowful" },// Fri
            { id: "joyful" }    // Sat
        ];

        // --- STATE ---
        const today = new Date();
        const realCurrentDayIndex = today.getDay(); 
        let selectedDayIndex = realCurrentDayIndex; 
        
        let appConfig = {
            language: 'en',
            pace: 1, 
            textSize: 'medium', 
            defaultMode: 'manual', 
            autoContinue: false, 
            rosaryStructure: 'daily',
            bgMusic: 'off',
            sfxEnabled: false,
            showText: true 
        };
        
        let currentSequence = [];
        let currentIndex = 0;
        let isAutoMode = false;
        let isScrolling = false;
        let activeWakeLock = null;
        let audio;
        let stepTimer = null;
        let DURATION = {};
        let currentGroupKey = ''; 
        const MS_PER_WORD = 350;

        // --- TRANSLATION HELPERS ---
        function getT(keyPath) {
            // Traverse object path e.g. 'ui.settings'
            const keys = keyPath.split('.');
            let val = translations[appConfig.language];
            for (let k of keys) {
                if(val) val = val[k];
            }
            return val || keyPath;
        }

        function getPrayerData(key) {
            return translations[appConfig.language].prayers[key];
        }

        // --- GENERATOR ---
        function generateSequence(mode, mysteryGroupId, startMysteryIndex = -1) {
            const sequence = [];
            let globalStepCounter = 0;
            // Get text titles and image urls
            const titles = translations[appConfig.language].mysteries.titles[mysteryGroupId];
            const images = imageAssets[mysteryGroupId];

            const addStep = (key, section, titleOverride, imgUrl, beadCount, beadIndex) => {
                const pData = getPrayerData(key);
                sequence.push({
                    index: globalStepCounter++,
                    key: key,
                    section: section,
                    flowTitle: titleOverride || pData.title,
                    imageUrl: imgUrl,
                    beadCount: beadCount,
                    beadIndex: beadIndex
                });
            };

            if (mode === 'full' || startMysteryIndex === 'intro') {
                const introTitle = translations[appConfig.language].mysteries.titles.special.intro;
                const introImg = imageAssets.special.intro;
                const introKeys = ['sotc', 'ac', 'of', 'hm', 'hm', 'hm', 'gb']; 
                const beadCount = 5;
                let beadIdx = 0;
                addStep('contemplation', 'intro', introTitle, introImg, beadCount, -1);
                introKeys.forEach(k => {
                    const isBead = (k==='hm' || k==='of' || k==='gb');
                    addStep(k, 'intro', null, introImg, beadCount, isBead ? beadIdx++ : -1);
                });
            }

            // Loop 5 mysteries
            for(let i=0; i<5; i++) {
                if (mode === 'daily' && i !== startMysteryIndex) continue;
                
                const mTitle = titles[i];
                const mImg = images[i];
                const sectionId = `mystery_${i+1}`;
                const decadeKeys = ['of', ...Array(10).fill('hm'), 'gbf'];
                const beadCount = 12;
                let beadIdx = 0;
                
                const mysteryLabel = getT('ui.mysteryLabel');
                addStep('contemplation', sectionId, `${mysteryLabel} ${i+1}: ${mTitle}`, mImg, beadCount, -1);
                
                decadeKeys.forEach((k, j) => {
                    const isBead = (k==='hm' || k==='of' || k==='gbf');
                    let title = null;
                    if(k==='hm') {
                        const prayerTitle = getPrayerData(k).title;
                        title = `${prayerTitle} (${j} / 10)`;
                    }
                    addStep(k, sectionId, title, mImg, beadCount, isBead ? beadIdx++ : -1);
                });
            }

            if (mode === 'full' || startMysteryIndex === 'conclusion') {
                const concTitle = translations[appConfig.language].mysteries.titles.special.conclusion;
                const concImg = imageAssets.special.conclusion;
                const closeKeys = ['hhq', 'ogws', 'sotc'];
                const beadCount = 0;
                addStep('contemplation', 'conclusion', concTitle, concImg, beadCount, -1);
                closeKeys.forEach(k => {
                    addStep(k, 'conclusion', null, concImg, beadCount, -1);
                });
            }
            return sequence;
        }

        // --- NAVIGATION ---
        function startRosarySession(groupKey, type, index, preservePlayState = null) {
            resetState();
            currentGroupKey = groupKey; 
            let mode = appConfig.rosaryStructure;
            if (type === 'special') mode = 'daily'; 

            currentSequence = generateSequence(mode, groupKey, index);
            
            if (mode === 'full' && type === 'mystery') {
                const targetSection = `mystery_${index + 1}`;
                const foundIndex = currentSequence.findIndex(step => step.section === targetSection);
                currentIndex = foundIndex !== -1 ? foundIndex : 0;
            } else {
                currentIndex = 0; 
            }

            if (currentSequence.length === 0) return; 

            document.getElementById('contemplation-view').classList.add('active');
            document.getElementById('list-view-container').style.display = 'none'; 
            
            if (appConfig.bgMusic !== 'off' && audio) {
                let vol = (appConfig.bgMusic === 'soft') ? 0.1 : 0.4;
                audio.volume = vol;
                audio.currentTime = 0;
                audio.play().catch(()=>{});
            }
            
            requestWakeLock();
            
            if (preservePlayState !== null) {
                isAutoMode = preservePlayState;
            } else {
                isAutoMode = (appConfig.defaultMode === 'auto');
            }

            updatePlayButtonUI(isAutoMode ? getT('ui.pause') : getT('ui.play'));
            applyTextVisibility();
            renderStep();
        }
        
        function renderStep() {
            const step = currentSequence[currentIndex];
            const pData = getPrayerData(step.key);
            const isContemplation = step.key === 'contemplation';

            if (appConfig.sfxEnabled) {
                let sfxId = '';
                if (step.key === 'contemplation') sfxId = 'sfx-page';
                else if (step.key === 'hm') sfxId = 'sfx-water';
                else if (step.key === 'of') sfxId = 'sfx-bell';
                else if (step.key === 'gb' || step.key === 'gbf') sfxId = 'sfx-chime';
                
                if (sfxId) {
                    const sound = document.getElementById(sfxId);
                    if (sound) {
                        sound.currentTime = 0;
                        sound.volume = 0.6; 
                        sound.play().catch(()=>{});
                    }
                }
            }

            document.getElementById('scroll-instruction').classList.remove('opacity-100');
            document.getElementById('scroll-instruction').classList.add('opacity-0');

            document.getElementById('modal-top-title').textContent = step.flowTitle;
            document.getElementById('current-prayer-title').textContent = isContemplation ? getT('prayers.contemplation.title') : step.flowTitle;

            const badge = document.getElementById('mystery-badge');
            if (step.section.startsWith('mystery_')) {
                badge.textContent = step.section.split('_')[1];
                badge.classList.remove('opacity-0');
            } else {
                badge.classList.add('opacity-0');
            }

            const imgEl = document.getElementById('modal-image');
            imgEl.src = step.imageUrl;
            imgEl.classList.remove('grayscale'); 
            imgEl.classList.add('full-color');
            
            // Reset Zoom
            const wrapperDiv = document.getElementById('image-wrapper');
            wrapperDiv.classList.remove('zoomed');
            wrapperDiv.scrollTop = 0;
            wrapperDiv.scrollLeft = 0;

            updateBeads(step);

            const finishBtn = document.getElementById('finish-section-btn');
            if (step.section === 'intro') finishBtn.textContent = getT('ui.skipIntro');
            else if (step.section === 'conclusion') finishBtn.textContent = getT('ui.finishRosary');
            else finishBtn.textContent = getT('ui.finish');

            // Text Rendering
            const contentEl = document.getElementById('dynamic-prayer-content');
            contentEl.innerHTML = '';
            contentEl.style.animation = 'none';
            contentEl.offsetHeight; 
            
            let textHtml = '';
            let duration = 0;

            if (isContemplation) {
                textHtml = `
                    <p class="text-gray-700 italic ${baseTextClass}">
                        ${step.flowTitle}<br><br>
                        ${pData.text}
                    </p>`;
                duration = DURATION.contemplation;
            } else {
                textHtml = `<p class="${scrollTextClass} text-gray-900 font-bold text-center leading-relaxed">${pData.text}</p>`;
                duration = DURATION[step.key];
            }

            const wrapper = document.createElement('div');
            wrapper.innerHTML = textHtml.trim();
            contentEl.appendChild(wrapper);
            
            const spacer = document.createElement('div');
            spacer.style.height = document.getElementById('modal-text-area').offsetHeight + 'px';
            contentEl.appendChild(spacer);

            const textHeight = wrapper.offsetHeight;
            const containerHeight = document.getElementById('modal-text-area').offsetHeight;
            
            if (textHeight > 0) {
                contentEl.style.setProperty('--start-position', `${containerHeight}px`);
                contentEl.style.setProperty('--end-position', `-${textHeight}px`);
                contentEl.style.animation = `prayerScroll ${duration/1000}s linear forwards`;
                isScrolling = true;

                contentEl.addEventListener('animationend', () => {
                    isScrolling = false;
                    if (!isAutoMode) {
                        document.getElementById('scroll-instruction').classList.remove('opacity-0');
                        document.getElementById('scroll-instruction').classList.add('opacity-100');
                    }
                }, { once: true });
            } else {
                if (!isAutoMode) {
                    document.getElementById('scroll-instruction').classList.remove('opacity-0');
                    document.getElementById('scroll-instruction').classList.add('opacity-100');
                }
            }

            if (isContemplation) {
                stepTimer = setTimeout(() => {
                    if (isAutoMode) {
                        handleNextStep();
                    } else {
                        document.getElementById('scroll-instruction').classList.remove('opacity-0');
                        document.getElementById('scroll-instruction').classList.add('opacity-100');
                    }
                }, duration);
            } else {
                if (isAutoMode) {
                    stepTimer = setTimeout(() => {
                        isScrolling = false;
                        handleNextStep();
                    }, duration);
                }
            }
        }

        // --- ZOOM LOGIC ---
        function toggleZoom() {
            const wrapper = document.getElementById('image-wrapper');
            wrapper.classList.toggle('zoomed');
            if(!wrapper.classList.contains('zoomed')) {
                wrapper.scrollTop = 0;
                wrapper.scrollLeft = 0;
            }
        }

        // --- TOGGLE TEXT LOGIC ---
        function toggleTextVisibility() {
            appConfig.showText = !appConfig.showText;
            saveSet(); 
            applyTextVisibility();
        }

        function toggleTextVisibilityFromSettings(isChecked) {
            appConfig.showText = isChecked;
            saveSet();
            applyTextVisibility(); 
        }

        function applyTextVisibility() {
            const container = document.getElementById('contemplation-view');
            const textArea = document.getElementById('modal-text-area');
            const icon = document.getElementById('toggle-icon');
            const checkBox = document.getElementById('show-text-checkbox');

            if (appConfig.showText) {
                container.classList.remove('view-text-hidden');
                container.classList.add('view-text-visible');
                textArea.style.display = 'block';
                icon.style.transform = 'rotate(0deg)';
                if(checkBox) checkBox.checked = true;
            } else {
                container.classList.remove('view-text-visible');
                container.classList.add('view-text-hidden');
                textArea.style.display = 'none';
                icon.style.transform = 'rotate(180deg)';
                if(checkBox) checkBox.checked = false;
            }
        }

        function updateBeads(step) {
            const roseCont = document.getElementById('rose-container');
            const currentSection = roseCont.dataset.section;
            if (currentSection !== step.section) {
                roseCont.innerHTML = '';
                roseCont.dataset.section = step.section;
                if (step.beadCount === 0) {
                    roseCont.innerHTML = `<span class="text-gray-500 font-medium uppercase text-sm tracking-widest">${step.section.toUpperCase()}</span>`;
                } else if (step.beadCount === 5) {
                    ['red-bead', 'white-bead', 'white-bead', 'white-bead', 'red-bead'].forEach((cls, i) => {
                        roseCont.innerHTML += `<span class="bead ${cls}" id="bead-${i}"></span>`;
                    });
                } else if (step.beadCount === 12) {
                    let html = `<span class="bead red-bead" id="bead-0"></span>`; 
                    for(let i=1; i<=10; i++) html += `<span class="bead white-bead" id="bead-${i}"></span>`; 
                    html += `<span class="bead red-bead" id="bead-11"></span>`; 
                    roseCont.innerHTML = html;
                }
            }
            const beads = roseCont.querySelectorAll('.bead');
            beads.forEach(b => b.classList.remove('current'));
            if (step.beadIndex >= 0 && beads[step.beadIndex]) {
                beads[step.beadIndex].classList.add('current');
            }
        }

        function handleNextStep() {
            clearTimer();
            if (currentIndex + 1 < currentSequence.length) {
                const currentSec = currentSequence[currentIndex].section;
                const nextSec = currentSequence[currentIndex+1].section;
                if (currentSec !== nextSec) {
                    if (appConfig.autoContinue) {
                        markSectionComplete(currentSec);
                        attemptAutoContinue(currentSec);
                        return; 
                    }
                    markSectionComplete(currentSec);
                }
                currentIndex++;
                renderStep();
            } else {
                if (appConfig.autoContinue) {
                    markSectionComplete(currentSequence[currentIndex].section);
                    attemptAutoContinue(currentSequence[currentIndex].section);
                } else {
                    finishSession(true);
                }
            }
        }

        function togglePlayPause() {
            if (isAutoMode) {
                isAutoMode = false;
                updatePlayButtonUI(getT('ui.play'));
            } else {
                isAutoMode = true;
                updatePlayButtonUI(getT('ui.pause'));
                if (!isScrolling) {
                    const step = currentSequence[currentIndex];
                    if (step.key === 'contemplation') {
                        handleNextStep();
                    } else {
                        handleNextStep(); 
                    }
                }
            }
        }

        function updatePlayButtonUI(label) {
            const btn = document.getElementById('play-pause-btn');
            btn.textContent = label;
            if (isAutoMode) {
                btn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                btn.classList.add('bg-yellow-600', 'hover:bg-yellow-700');
            } else {
                btn.classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
                btn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
            }
        }

        function userNextStep() {
            clearTimer(); 
            handleNextStep(); 
        }

        function finishCurrentSection() {
            clearTimer();
            const currentStep = currentSequence[currentIndex];
            const currentSection = currentStep.section;
            markSectionComplete(currentSection);
            let nextSectionIndex = -1;
            for(let i = currentIndex; i < currentSequence.length; i++) {
                if (currentSequence[i].section !== currentSection) {
                    nextSectionIndex = i;
                    break;
                }
            }
            if (nextSectionIndex !== -1) {
                currentIndex = nextSectionIndex;
                renderStep();
            } else {
                if (appConfig.autoContinue) {
                    attemptAutoContinue(currentSection);
                } else {
                    finishSession(true);
                }
            }
        }
        
        function attemptAutoContinue(completedSection) {
            let nextType = '', nextIndex = -1;
            const wasPlaying = isAutoMode;

            if (completedSection === 'intro') {
                nextType = 'mystery';
                nextIndex = 0; 
            } else if (completedSection.startsWith('mystery_')) {
                const currentId = parseInt(completedSection.split('_')[1]);
                if (currentId < 5) {
                    nextType = 'mystery';
                    nextIndex = currentId; 
                } else {
                    if (appConfig.rosaryStructure === 'full') {
                        nextType = 'special';
                        nextIndex = 'conclusion';
                    }
                }
            } 
            if (nextType) {
                startRosarySession(currentGroupKey, nextType, nextIndex, wasPlaying);
            } else {
                finishSession(true);
            }
        }

        function markSectionComplete(section) {
            if (section === 'intro' || section === 'conclusion') {
                markAsCompleted(`${currentGroupKey}_${section}`);
            } else if (section.startsWith('mystery_')) {
                const id = section.split('_')[1];
                markAsCompleted(`${currentGroupKey}_${id}`);
            }
        }

        function finishSession(isComplete) {
            if (isComplete && currentIndex < currentSequence.length) {
                markSectionComplete(currentSequence[currentIndex].section);
            }
            clearTimer();
            if (audio) { audio.pause(); audio.currentTime = 0; }
            releaseWakeLock();
            document.getElementById('contemplation-view').classList.remove('active');
            document.getElementById('list-view-container').style.display = 'block'; 
            updateMainDisplay(selectedDayIndex);
        }

        function clearTimer() {
            if (stepTimer) clearTimeout(stepTimer);
            stepTimer = null;
            const content = document.getElementById('dynamic-prayer-content');
            if(content) { content.style.animation = 'none'; content.style.transform = 'translateY(0)'; }
            isScrolling = false;
        }

        function resetState() {
            clearTimer();
            document.getElementById('rose-container').innerHTML = '';
            document.getElementById('rose-container').dataset.section = '';
        }

        function getCurrentDateKey() { return 'rosary_' + new Date().toISOString().split('T')[0]; }
        function loadCompletedStatus() { return JSON.parse(localStorage.getItem(getCurrentDateKey()) || '{}'); }
        function markAsCompleted(key) {
            const data = loadCompletedStatus();
            data[key] = true;
            localStorage.setItem(getCurrentDateKey(), JSON.stringify(data));
        }

        function updateMainDisplay(dayIdx) {
            // Apply Translation
            updateLabels();

            const sched = mysterySchedule[dayIdx];
            const groupKey = sched.id;
            const status = loadCompletedStatus();
            
            // Translated Texts
            const dayName = translations[appConfig.language].days[dayIdx];
            const groupName = translations[appConfig.language].mysteries[groupKey];
            const todayLabel = getT('ui.today');
            const viewingLabel = getT('ui.viewing');
            
            document.getElementById('current-day-text').textContent = (dayIdx===realCurrentDayIndex) ? `${todayLabel}, ${dayName}` : `${viewingLabel} ${dayName}`;
            document.getElementById('mystery-group-name').textContent = groupName;
            document.getElementById('mystery-list-title').textContent = (appConfig.rosaryStructure === 'full') ? getT('ui.fullSeq') : getT('ui.dailySeq');
            
            let html = '';
            // Intro
            if (appConfig.rosaryStructure === 'full') {
                const introTitle = translations[appConfig.language].mysteries.titles.special.intro;
                html += createCard({id:'intro', title:introTitle, imageUrl:imageAssets.special.intro}, 'special', groupKey, -1, status);
            }
            // Mysteries
            const mTitles = translations[appConfig.language].mysteries.titles[groupKey];
            const mImgs = imageAssets[groupKey];
            for(let i=0; i<5; i++) {
                html += createCard({id: i+1, title: mTitles[i], imageUrl: mImgs[i]}, 'mystery', groupKey, i, status);
            }
            // Conclusion
            if (appConfig.rosaryStructure === 'full') {
                const concTitle = translations[appConfig.language].mysteries.titles.special.conclusion;
                html += createCard({id:'conclusion', title:concTitle, imageUrl:imageAssets.special.conclusion}, 'special', groupKey, -1, status);
            }
            document.getElementById('daily-mysteries-container').innerHTML = html;
        }

        function updateLabels() {
            // Static labels update
            document.getElementById('lbl-settings-title').textContent = getT('ui.settings');
            document.getElementById('lbl-language').textContent = getT('ui.language');
            document.getElementById('lbl-structure').textContent = getT('ui.structure');
            document.getElementById('lbl-mode').textContent = getT('ui.mode');
            document.getElementById('lbl-pace').textContent = getT('ui.pace');
            document.getElementById('lbl-textsize').textContent = getT('ui.textsize');
            document.getElementById('lbl-music').textContent = getT('ui.bgmusic');
            document.getElementById('lbl-sfx').textContent = getT('ui.sfx');
            document.getElementById('lbl-autocontinue').textContent = getT('ui.autocontinue');
            document.getElementById('lbl-showtext').textContent = getT('ui.showtext');
            
            document.getElementById('opt-daily').textContent = getT('ui.daily');
            document.getElementById('opt-full').textContent = getT('ui.full');
            document.getElementById('opt-manual').textContent = getT('ui.manual');
            document.getElementById('opt-auto').textContent = getT('ui.auto');
            document.getElementById('opt-med').textContent = getT('ui.medium');
            document.getElementById('opt-small').textContent = getT('ui.small');
            document.getElementById('opt-large').textContent = getT('ui.large');
            document.getElementById('opt-off').textContent = getT('ui.off');
            document.getElementById('opt-soft').textContent = getT('ui.soft');
            document.getElementById('opt-loud').textContent = getT('ui.loud');

            document.getElementById('lbl-subtitle').textContent = getT('ui.subtitle');
            document.getElementById('reset-button').textContent = getT('ui.reset');
            document.getElementById('btn-showcycle').textContent = getT('ui.cycle');
            document.getElementById('lbl-selectday').textContent = getT('ui.selectday').replace('*', (realCurrentDayIndex===selectedDayIndex?'*':''));
            document.getElementById('lbl-zoomhint').textContent = getT('ui.zoomHint');
            document.getElementById('lbl-instruction').textContent = getT('ui.instruction');
            document.getElementById('play-pause-btn').textContent = isAutoMode ? getT('ui.pause') : getT('ui.play');
            document.getElementById('next-btn').textContent = getT('ui.next');
            
            // Buttons in modal update dynamically in renderStep but set base here
            document.getElementById('modal-title').textContent = getT('ui.modalResetTitle');
            document.getElementById('modal-message').textContent = getT('ui.modalResetMsg');
            document.getElementById('modal-confirm').textContent = getT('ui.confirm');
            document.getElementById('modal-cancel').textContent = getT('ui.cancel');
        }

        function createCard(data, type, groupKey, idx, status) {
            const isSpecial = type === 'special';
            const idKey = isSpecial ? `${groupKey}_${data.id}` : `${groupKey}_${data.id}`;
            const isDone = idKey ? status[idKey] : false;
            const filter = isDone ? 'grayscale' : 'full-color';
            let label = "";
            if(isSpecial) {
                label = (data.id==='intro') ? getT('ui.introLabel') : getT('ui.conclLabel');
            } else {
                label = `${getT('ui.mysteryLabel')} ${data.id}`;
            }
            const indexParam = isSpecial ? `'${data.id}'` : idx;
            
            return `
            <div onclick="startRosarySession('${groupKey}', '${type}', ${indexParam})" 
                 class="mystery-box bg-white rounded-lg overflow-hidden shadow-md relative h-48">
                <img src="${data.imageUrl}" class="w-full h-full object-cover ${filter}">
                <div class="absolute inset-0 bg-gradient-to-t from-gray-900/80 to-transparent p-4 flex flex-col justify-end text-center">
                    <span class="text-xs font-medium text-white opacity-90">${label}</span>
                    <h4 class="text-xl font-bold text-white">${data.title}</h4>
                    ${isDone ? `<span class="text-xs text-green-300 font-bold mt-1">${getT('ui.completed')}</span>` : ''}
                </div>
            </div>`;
        }

        // --- CALCULATION ---
        function calculateDurations() {
            // Need to calc based on current lang
            // Just use a heuristic or re-run when language changes
            // Simple heuristic: standard length
            const p = translations[appConfig.language].prayers;
            for (let k in p) {
                if (k === 'contemplation') {
                    DURATION[k] = 10000 / appConfig.pace;
                } else {
                    const text = p[k].text;
                    const words = text.split(/\s+/).length;
                    DURATION[k] = Math.max(2000, (words * MS_PER_WORD) / appConfig.pace);
                }
            }
        }
        
        // --- LOAD SETTINGS ---
        function loadSettings() {
            const s = JSON.parse(localStorage.getItem('rosarySettings') || '{}');
            appConfig = { ...appConfig, ...s };
            // Apply to UI
            if(document.getElementById('language-select')) document.getElementById('language-select').value = appConfig.language;
            if(document.getElementById('structure-select')) document.getElementById('structure-select').value = appConfig.rosaryStructure;
            if(document.getElementById('mode-select')) document.getElementById('mode-select').value = appConfig.defaultMode;
            if(document.getElementById('speed-select')) document.getElementById('speed-select').value = appConfig.pace;
            if(document.getElementById('size-select')) document.getElementById('size-select').value = appConfig.textSize;
            if(document.getElementById('auto-continue-checkbox')) document.getElementById('auto-continue-checkbox').checked = appConfig.autoContinue;
            if(document.getElementById('music-select')) document.getElementById('music-select').value = appConfig.bgMusic || 'off';
            if(document.getElementById('sfx-checkbox')) document.getElementById('sfx-checkbox').checked = appConfig.sfxEnabled;
            if(document.getElementById('show-text-checkbox')) document.getElementById('show-text-checkbox').checked = (appConfig.showText !== false);
        }

        // --- HANDLERS ---
        window.updateLanguage = (v) => { appConfig.language = v; saveSet(); calculateDurations(); updateMainDisplay(selectedDayIndex); };
        window.updateRosaryStructure = (v) => { appConfig.rosaryStructure = v; saveSet(); updateMainDisplay(selectedDayIndex); };
        window.updateDefaultMode = (v) => { appConfig.defaultMode = v; saveSet(); };
        window.updateSpeed = (v) => { appConfig.pace = parseFloat(v); calculateDurations(); saveSet(); };
        window.updateTextSize = (v) => { appConfig.textSize = v; saveSet(); updateTextStyle(); }; 
        window.updateAutoContinue = (v) => { appConfig.autoContinue = v; saveSet(); };
        window.updateMusicVolume = (val) => {
            appConfig.bgMusic = val;
            saveSet();
            let vol = 0;
            if(val === 'soft') vol = 0.1;
            if(val === 'loud') vol = 0.4;
            if (audio) {
                audio.volume = vol;
                if (val === 'off') {
                    audio.pause();
                } else {
                    if(document.getElementById('contemplation-view').classList.contains('active')) {
                        audio.play().catch(()=>{});
                    }
                }
            }
        };
        window.updateSfxEnabled = (isChecked) => { appConfig.sfxEnabled = isChecked; saveSet(); };
        
        function saveSet() { localStorage.setItem('rosarySettings', JSON.stringify(appConfig)); }

        function updateTextStyle() {
            if(appConfig.textSize === 'small') { baseTextClass='text-sm'; scrollTextClass='text-lg'; }
            else if(appConfig.textSize === 'large') { baseTextClass='text-lg'; scrollTextClass='text-2xl'; }
            else { baseTextClass='text-base'; scrollTextClass='text-xl'; }
        }

        window.toggleMute = () => { if(audio) { isMuted=!isMuted; audio.muted=isMuted; } };
        async function requestWakeLock() { try { if('wakeLock' in navigator) activeWakeLock = await navigator.wakeLock.request('screen'); } catch(e){} }
        function releaseWakeLock() { if(activeWakeLock) { activeWakeLock.release(); activeWakeLock=null; } }
        
        window.populateCycleList = (real, sel) => {
            const list = document.getElementById('cycle-list'); list.innerHTML='';
            translations[appConfig.language].days.forEach((d, i) => {
                const isActive = i===sel;
                const mTitle = translations[appConfig.language].mysteries[mysterySchedule[i].id];
                list.innerHTML += `<div onclick="selectedDayIndex=${i}; updateMainDisplay(${i}); populateCycleList(${real}, ${i})" 
                class="flex justify-between p-2 rounded cursor-pointer ${isActive?'bg-indigo-600 text-white':'bg-gray-50 hover:bg-gray-100'}">
                <span>${d}${i===real?' *':''}</span><span>${mTitle}</span></div>`;
            });
        };
        window.confirmReset = () => {
            document.getElementById('custom-modal').classList.remove('hidden');
            // Text updates in updateLabels
        };
        document.getElementById('modal-confirm').onclick = () => {
            localStorage.removeItem(getCurrentDateKey());
            document.getElementById('custom-modal').classList.add('hidden');
            updateMainDisplay(selectedDayIndex);
        };
        document.getElementById('modal-cancel').onclick = () => document.getElementById('custom-modal').classList.add('hidden');
        
        window.toggleSettingsPanel = () => document.getElementById('settings-panel').classList.toggle('active');

        document.addEventListener('DOMContentLoaded', () => {
            audio = document.getElementById('background-music');
            loadSettings(); 
            calculateDurations();
            updateTextStyle();
            updateMainDisplay(selectedDayIndex);
        });

    </script>
</body>
</html>
