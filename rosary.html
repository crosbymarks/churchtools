<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Rosary Mystery Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f7f3f1; /* Soft, light background */
        }
        .card {
            box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .mystery-box {
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .mystery-box:hover {
            border-color: #4f46e5;
            transform: translateY(-2px);
        }
        .mystery-image-container img {
            transition: filter 0.5s ease-in-out;
        }
        .grayscale {
            filter: grayscale(100%);
        }
        .full-color {
            filter: none;
        }

        /* Custom styles for the Modal/Contemplation View */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #f7f3f1;
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
        }
        .modal.active {
            opacity: 1;
            visibility: visible;
        }
        .contemplation-image {
            max-height: 40vh; 
            width: 100%;
            object-fit: contain; 
        }
        /* Styles for the Rosary Beads (Roses) */
        .bead {
            display: inline-block;
            width: 20px; 
            height: 20px;
            border-radius: 50%;
            margin: 4px; 
            transition: all 0.2s ease-in-out; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            opacity: 0;
            animation: fadeIn 0.5s forwards;
            flex-shrink: 0; 
        }
        .red-bead {
            background-color: #ef4444; 
        }
        .white-bead {
            background-color: #ffffff; 
            border: 1px solid #d1d5db; 
        }
        .bead.current {
            transform: scale(1.2);
            box-shadow: 0 0 0 4px #a78bfa; /* Ring highlight */
        }
        /* Dynamic Scrolling Animation */
        @keyframes prayerScroll {
            0% { transform: translateY(var(--start-position)); }
            100% { transform: translateY(var(--end-position)); }
        }
        .scrolling-text {
            animation-name: prayerScroll;
            animation-timing-function: linear;
            animation-fill-mode: forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.5); }
            to { opacity: 1; transform: scale(1); }
        }
        /* Settings Panel specific styles */
        #settings-panel.active {
            transform: translateY(0);
        }
        /* Button styles */
        .control-btn {
            padding: 0.75rem 1rem;
            border-radius: 9999px; /* full rounded */
            font-weight: 600;
            transition: all 0.2s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        /* Text area for the scrolling content to handle overflow */
        #modal-text-area {
            overflow-y: hidden;
            position: relative; /* Ensure the content wrapper is relative */
        }
        #dynamic-prayer-content {
            position: absolute;
            width: 100%;
            padding: 0 24px; /* Match parent padding-x */
            top: 0;
            left: 0;
            /* Ensure text starts off-screen when scrolling begins */
            transform: translateY(var(--start-position, 0)); 
        }
    </style>
</head>
<body class="p-4">

    <audio id="background-music" loop playsinline>
        <source src="instrumental-piano-christian-worship-of-jesus-301250.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

    <div id="settings-panel" class="fixed inset-x-0 top-0 transform -translate-y-full transition-transform duration-300 z-40 bg-white shadow-xl p-6 rounded-b-xl max-w-lg mx-auto">
        <div class="flex justify-between items-center mb-6 border-b pb-4">
            <h3 class="text-2xl font-bold text-indigo-700">App Settings</h3>
            <button onclick="toggleSettingsPanel()" class="p-2 text-gray-500 hover:text-gray-900 rounded-full hover:bg-gray-100 transition">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        
        <div class="space-y-4">
            <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg shadow-sm">
                <label for="mode-select" class="block text-base font-medium text-gray-700">Default Mode</label>
                <select id="mode-select" onchange="updateDefaultMode(this.value)" 
                        class="block w-1/3 py-2 text-sm rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 transition">
                    <option value="manual">Manual</option>
                    <option value="auto">Auto Play</option>
                </select>
            </div>

            <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg shadow-sm">
                <label for="speed-select" class="block text-base font-medium text-gray-700">Contemplation Pace</label>
                <select id="speed-select" onchange="updateSpeed(this.value)" 
                        class="block w-1/3 py-2 text-sm rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 transition">
                    <option value="1.0">1x</option>
                    <option value="1.25">1.25x</option>
                    <option value="1.5">1.5x</option>
                    <option value="2.0">2x</option>
                </select>
            </div>

            <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg shadow-sm">
                <label for="size-select" class="block text-base font-medium text-gray-700">Text Size</label>
                <select id="size-select" onchange="updateTextSize(this.value)" 
                        class="block w-1/3 py-2 text-sm rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 transition">
                    <option value="medium">Medium</option>
                    <option value="small">Small</option>
                    <option value="large">Large</option>
                </select>
            </div>

            <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg shadow-sm">
                <span class="text-base font-medium text-gray-700">Background Music</span>
                <button id="mute-button" onclick="toggleMute()" class="p-2 text-indigo-600 hover:text-indigo-800 rounded-full hover:bg-indigo-100 transition flex items-center">
                    <span id="mute-status" class="text-sm mr-2 font-semibold"></span>
                    <span id="speaker-icon" class="text-2xl"></span>
                </button>
            </div>
            
            <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg shadow-sm">
                <label for="auto-continue-checkbox" class="block text-base font-medium text-gray-700 select-none">Auto Continue Mysteries</label>
                <input type="checkbox" id="auto-continue-checkbox" onchange="updateAutoContinue(this.checked)" 
                       class="h-6 w-6 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 transition cursor-pointer">
            </div>

        </div>
    </div>


    <div id="list-view" class="card bg-white w-full max-w-lg mx-auto rounded-xl p-6 md:p-8 transition-all duration-300">

        <header id="list-view-header" class="flex justify-between items-start mb-6">
            
            <button id="settings-button" onclick="toggleSettingsPanel()" class="flex-shrink-0 p-2 text-gray-600 hover:text-indigo-600 rounded-full hover:bg-gray-100 transition mt-2">
                <span class="text-2xl font-extrabold">&#9881;</span>
            </button>

            <div class="text-center flex-grow mx-4">
                <h1 class="text-3xl font-bold text-gray-800 mb-1">
                    <span class="text-indigo-600">Visio Divina</span> Rosary
                </h1>
                <p class="text-base text-gray-500">
                    Contemplation through sacred images.
                </p>
            </div>
            
            <button class="flex-shrink-0 p-2 mt-2 invisible">
                <span class="text-2xl font-extrabold">&#9881;</span>
            </button>
        </header>

        <div class="text-center p-4 bg-indigo-50 rounded-lg border-2 border-indigo-200 mb-6">
            <p class="text-sm font-semibold text-indigo-700 uppercase tracking-wider mb-2" id="current-day-text">
                Loading schedule...
            </p>
            <h2 id="mystery-group-name" class="text-3xl sm:text-4xl leading-tight font-extrabold text-indigo-800 transition-opacity duration-500">
                Loading...
            </h2>
        </div>
        
        <div class="flex justify-between items-center border-b pb-2 mb-4">
            <h3 class="text-lg font-semibold text-gray-700">The Five Daily Mysteries</h3>
            
            <button id="reset-button" onclick="window.confirmReset()" class="px-3 py-1 text-sm bg-red-100 text-red-600 rounded-full shadow-sm hover:bg-red-200 transition font-medium flex-shrink-0" style="min-width: 100px;">
                Reset Day
            </button>
        </div>
        
        <div id="daily-mysteries-container" class="space-y-4">
            </div>
        
        <div class="mt-8 pt-4 border-t border-gray-200">
            <button onclick="document.getElementById('cycle-list-wrapper').classList.toggle('hidden'); if(!document.getElementById('cycle-list-wrapper').classList.contains('hidden')) populateCycleList(realCurrentDayIndex, selectedDayIndex);" 
                    class="w-full text-sm text-indigo-600 hover:text-indigo-800 font-medium py-2 rounded-md transition duration-150">
                Show/Hide Full Weekly Cycle & Selector
            </button>
            <div id="cycle-list-wrapper" class="hidden">
                <p class="text-sm font-semibold text-gray-600 mt-4 mb-2">Select a Day (Actual Current Day: *)</p>
                <div id="cycle-list" class="space-y-1 text-sm">
                    </div>
            </div>
        </div>

    </div>
    
    <div id="contemplation-view" class="modal">
        <div class="p-4 flex justify-end items-center bg-white shadow-md flex-shrink-0 relative">
            <h3 id="modal-mystery-title" class="absolute inset-x-4 text-center text-xl font-bold text-gray-800 truncate"></h3>
            
            <button onclick="closeContemplationView()" class="p-2 text-gray-500 hover:text-gray-900 rounded-full hover:bg-gray-100 transition flex-shrink-0 z-10">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>

        <div class="flex-grow flex flex-col items-center justify-start p-4 overflow-y-auto">
            
            <div id="rose-container" class="flex flex-wrap justify-center w-full max-w-xl mb-4 py-2 border-b border-gray-300 min-h-14 flex-shrink-0">
                </div>

            <div class="w-full max-w-xl bg-white rounded-xl shadow-2xl p-2 mb-4 flex-shrink-0">
                <img id="modal-image" class="contemplation-image rounded-lg full-color" alt="Contemplation Image" 
                     onerror="this.onerror=null; this.src='https://placehold.co/800x400/cccccc/000000?text=Image+Load+Error';">
            </div>
            
            <div id="prayer-title-display" class="w-full max-w-xl p-3 mb-2 bg-indigo-100 rounded-lg shadow-inner text-center flex-shrink-0">
                <h4 id="current-prayer-title" class="text-xl font-semibold text-indigo-800">Contemplation</h4>
            </div>
            
            <div id="modal-text-area" class="w-full max-w-xl bg-white rounded-xl shadow-lg p-6 h-40 flex-shrink-0">
                <div id="dynamic-prayer-content" class="text-lg text-gray-700 italic text-center"> 
                    <p id="dynamic-prayer-text">
                        Gaze upon this image. What emotion does it evoke? What detail catches your attention? How does it connect you to the life of Christ or Mary?
                    </p>
                </div>
            </div>

            <div class="flex justify-center flex-wrap gap-3 w-full max-w-xl mt-6 pb-4 flex-shrink-0">
                <button id="manual-btn" onclick="setManualMode()" class="control-btn bg-yellow-500 text-white hover:bg-yellow-600">
                    Manual
                </button>
                <button id="auto-play-btn" onclick="setAutoMode()" class="control-btn bg-indigo-600 text-white hover:bg-indigo-700">
                    Auto Play
                </button>
                <button id="skip-btn" onclick="skipPrayer()" class="control-btn bg-gray-500 text-white hover:bg-gray-600">
                    Skip Prayer
                </button>
                <button id="skip-to-end-btn" onclick="closeContemplationView()" class="control-btn bg-red-500 text-white hover:bg-red-600">
                    Finish Mystery
                </button>
            </div>
        </div>
    </div>
    
    <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-xl p-6 shadow-2xl max-w-sm w-full text-center">
            <h3 id="modal-title" class="text-xl font-bold text-gray-800 mb-4"></h3>
            <p id="modal-message" class="text-gray-600 mb-6"></p>
            <div class="flex justify-center space-x-4">
                <button id="modal-confirm" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition shadow">Confirm</button>
                <button id="modal-cancel" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition shadow">Cancel</button>
            </div>
        </div>
    </div>


    <script>
        // --- DATA ---
        const allMysteries = {
            "Joyful Mysteries": [
                { id: 1, title: "The Annunciation", imageUrl: "https://upload.wikimedia.org/wikipedia/commons/0/0e/Fra_Angelico_-_The_Annunciation_-_WGA00555.jpg" },
                { id: 2, title: "The Visitation", imageUrl: "https://upload.wikimedia.org/wikipedia/commons/d/dc/La_Visitation_avec_Marie-Jacobie_et_Marie-Salom%C3%A9_-_Domenico_Ghirlandaio_-_Mus%C3%A9e_du_Louvre_Peintures_INV_297_%3B_MR_240.jpg" },
                { id: 3, title: "The Nativity", imageUrl: "https://upload.wikimedia.org/wikipedia/commons/6/64/Geertgen_tot_Sint_Jans%2C_The_Nativity_at_Night%2C_c_1490.jpg" },
                { id: 4, title: "The Presentation in the Temple", imageUrl: "https://upload.wikimedia.org/wikipedia/commons/f/f7/Rembrandt_-_Circumcision_-_WGA19111.jpg" },
                { id: 5, title: "The Finding in the Temple", imageUrl: "https://upload.wikimedia.org/wikipedia/commons/5/51/Cima_da_Conegliano_Christ_among_the_doctors.jpg" }
            ],
            "Sorrowful Mysteries": [
                { id: 1, title: "The Agony in the Garden", imageUrl: "https://upload.wikimedia.org/wikipedia/commons/1/10/Bellini%2CGiovanni_-_Agony_in_the_Garden_-_National_Gallery.jpg" },
                { id: 2, title: "The Scourging at the Pillar", imageUrl: "https://upload.wikimedia.org/wikipedia/commons/1/11/Piero_-_The_Flagellation.jpg" },
                { id: 3, title: "The Crowning with Thorns", imageUrl: "https://upload.wikimedia.org/wikipedia/commons/5/52/Caravaggio%2C_Crowning_of_Thorns.jpg" },
                { id: 4, title: "The Carrying of the Cross", imageUrl: "https://upload.wikimedia.org/wikipedia/commons/5/5d/Hieronymus_Bosch_-_Christ_Carrying_the_Cross_-_WGA2498.jpg" },
                { id: 5, title: "The Crucifixion", imageUrl: "https://upload.wikimedia.org/wikipedia/commons/d/d3/Lotto%2C_crocifissione_01.jpg" }
            ],
            "Glorious Mysteries": [
                { id: 1, title: "The Resurrection", imageUrl: "https://upload.wikimedia.org/wikipedia/commons/c/c2/Resurrection.JPG" },
                { id: 2, title: "The Ascension", imageUrl: "https://upload.wikimedia.org/wikipedia/commons/0/01/Jacopo_Tintoretto_-_The_Ascension_-_WGA22570.jpg" },
                { id: 3, title: "The Descent of the Holy Spirit", imageUrl: "https://upload.wikimedia.org/wikipedia/commons/5/5a/Titian_-_The_Descent_of_the_Holy_Ghost_-_WGA22768.jpg" },
                { id: 4, title: "The Assumption of Mary", imageUrl: "https://upload.wikimedia.org/wikipedia/commons/9/9e/Tizian_041.jpg" },
                { id: 5, title: "The Coronation of Mary", imageUrl: "https://upload.wikimedia.org/wikipedia/commons/b/b5/Diego_Vel%C3%A1zquez_-_Coronation_of_the_Virgin_-_Prado.jpg" }
            ],
            "Luminous Mysteries": [
                { id: 1, title: "The Baptism of Jesus in the Jordan", imageUrl: "https://upload.wikimedia.org/wikipedia/commons/5/5a/Piero_della_Francesca_-_Baptism_of_Christ_-_WGA17595.jpg" },
                { id: 2, title: "The Wedding Feast at Cana", imageUrl: "https://upload.wikimedia.org/wikipedia/commons/2/21/Paolo_Veronese%2C_The_Wedding_at_Cana.JPG" },
                { id: 3, title: "The Proclamation of the Kingdom of God", imageUrl: "https://upload.wikimedia.org/wikipedia/commons/9/96/Bloch-SermonOnTheMount.jpg" },
                { id: 4, title: "The Transfiguration", imageUrl: "https://upload.wikimedia.org/wikipedia/commons/5/51/Transfiguration_Raphael.jpg" },
                { id: 5, title: "The Institution of the Eucharist", imageUrl: "https://upload.wikimedia.org/wikipedia/commons/0/08/Leonardo_da_Vinci_%281452-1519%29_-_The_Last_Apper_%281495-1498%29.jpg" }
            ]
        };

        const mysterySchedule = {
            0: { name: "Glorious Mysteries", color: "gold" }, // Sunday
            1: { name: "Joyful Mysteries", color: "green" }, // Monday
            2: { name: "Sorrowful Mysteries", color: "red" }, // Tuesday
            3: { name: "Glorious Mysteries", color: "gold" }, // Wednesday
            4: { name: "Luminous Mysteries", color: "blue" }, // Thursday
            5: { name: "Sorrowful Mysteries", color: "red" }, // Friday
            6: { name: "Joyful Mysteries", color: "green" }  // Saturday
        };

        const dayNames = [
            "Sunday", "Monday", "Tuesday", "Wednesday",
            "Thursday", "Friday", "Saturday"
        ];
        
        // --- CONSTANTS & STATE (App Config) ---
        const today = new Date();
        const realCurrentDayIndex = today.getDay(); 
        let selectedDayIndex = realCurrentDayIndex; 

        let appConfig = {
            pace: 1.0,
            textSize: 'medium',
            defaultMode: 'manual',
            autoContinue: false
        };
        
        let baseTextClass = 'text-base'; 
        let scrollTextClass = 'text-xl'; 
        let wakeLockSentinel = null;
        const MS_PER_WORD = 350; 

        let BASE_OF_DURATION = 0;
        let BASE_HM_DURATION = 0; 
        let BASE_GB_DURATION = 0;

        let speedFactor = 1.0;
        let D_OF_DURATION = 0;
        let D_HM_DURATION = 0;
        let D_GB_DURATION = 0;

        // Runtime State (Contemplation View)
        let currentMysteryGroupKey = ''; // Key (e.g., 'Joyful Mysteries')
        let currentMysteryIndex = 0; // 0 to 4
        let currentPrayerIndex = -1; // -1 for contemplation, 0-11 for prayers
        let isAutoMode = false; 
        let isScrolling = false; 

        // Timer Refs
        let audio;
        let isMuted = false;
        let scrollCompletionTimer; 
        const modalEl = document.getElementById('contemplation-view');
        const manualBtn = document.getElementById('manual-btn');
        const autoPlayBtn = document.getElementById('auto-play-btn');


        // --- LOCAL STORAGE UTILS ---

        function getCurrentDateKey() {
            // Key format: 'rosary_2025-12-05'
            return 'rosary_' + new Date().toISOString().split('T')[0];
        }

        /**
         * Loads the completion status for the current day from Local Storage.
         * The stored data looks like: { 'Joyful Mysteries_1': true, 'Joyful Mysteries_2': true, ... }
         */
        function loadCompletedStatus() {
            const key = getCurrentDateKey();
            const stored = localStorage.getItem(key);
            try {
                // Return status for the current day, or an empty object
                return stored ? JSON.parse(stored) : {};
            } catch (e) {
                console.error("Error parsing progress from Local Storage:", e);
                return {};
            }
        }

        /**
         * Marks a specific mystery as completed in Local Storage.
         * @param {string} mysteryKey - The key (e.g., 'Joyful Mysteries_1')
         */
        function markAsCompleted(mysteryKey) {
            const key = getCurrentDateKey();
            const status = loadCompletedStatus();
            
            // Filter status to only keep keys relevant to the currently selected mystery group
            // This prevents status for other days from accumulating unnecessarily if the user switches days.
            const currentGroupStatus = {};
            const groupKey = mysteryKey.split('_')[0];
            Object.keys(status).forEach(k => {
                 if (k.startsWith(groupKey)) {
                     currentGroupStatus[k] = status[k];
                 }
            });
            
            currentGroupStatus[mysteryKey] = true;
            localStorage.setItem(key, JSON.stringify(currentGroupStatus));
        }
        
        window.confirmReset = function() {
            showCustomModal(
                'Confirm Reset',
                'Are you sure you want to clear your completion status for TODAY? This cannot be undone.',
                () => { // Confirm Action
                    const key = getCurrentDateKey();
                    localStorage.removeItem(key);
                    updateMainDisplay(selectedDayIndex); // Re-render to show reset
                    hideCustomModal();
                },
                () => hideCustomModal() // Cancel Action
            );
        }

        // Custom Modal UI
        function showCustomModal(title, message, onConfirm, onCancel) {
            const modal = document.getElementById('custom-modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            
            const confirmBtn = document.getElementById('modal-confirm');
            const cancelBtn = document.getElementById('modal-cancel');

            // Clear previous listeners
            confirmBtn.onclick = null;
            cancelBtn.onclick = null;

            // Set new listeners
            confirmBtn.onclick = onConfirm;
            cancelBtn.onclick = onCancel;
            
            modal.classList.remove('hidden');
        }

        function hideCustomModal() {
            document.getElementById('custom-modal').classList.add('hidden');
        }


        // --- PRAYER CONTENT & UTILS ---

        function getWordCount(text) {
            const cleanText = text.replace(/<[^>]*>?/gm, '').trim();
            if (cleanText === '') return 0;
            return cleanText.split(/\s+/).length;
        }

        function calculateBaseDurations() {
            const p_HM = "Hail Mary, full of grace, the Lord is with thee. Blessed art thou amongst women, and blessed is the fruit of thy womb, Jesus. Holy Mary, Mother of God, pray for us sinners, now and at the hour of our death. Amen.";
            const p_OF = "Our Father, Who art in heaven, Hallowed be Thy Name. Thy Kingdom come, Thy Will be done, on Earth as it is in Heaven. Give us this day our daily bread, and forgive us our trespasses, as we forgive those who trespass against us. And lead us not into temptation, but deliver us from evil. Amen.";
            const p_GB = "Glory be to the Father, and to the Son, and to the Holy Spirit. As it was in the beginning, is now, and ever shall be, world without end. Amen. O my Jesus, forgive us our sins, save us from the fires of hell, lead all souls to Heaven, especially those in most need of Thy mercy.";
            
            BASE_OF_DURATION = getWordCount(p_OF) * MS_PER_WORD + 2000;
            BASE_HM_DURATION = getWordCount(p_HM) * MS_PER_WORD + 2000;
            BASE_GB_DURATION = getWordCount(p_GB) * MS_PER_WORD + 2000;
        }
        
        function recalcDurations() {
            const speed = appConfig.pace;
            D_OF_DURATION = Math.floor(BASE_OF_DURATION / speed);
            D_HM_DURATION = Math.floor(BASE_HM_DURATION / speed);
            D_GB_DURATION = Math.floor(BASE_GB_DURATION / speed);
        }

        const getInitialContemplationText = (mysteryTitle) => `
            <p class="text-gray-700 italic ${baseTextClass}">
                Meditating on: <span class="font-bold text-indigo-800">${mysteryTitle}</span>
                <br>
                Gaze upon this image. What emotion does it evoke? What detail catches your attention? How does it connect you to the life of Christ or Mary?
                <br><br>
                Press <span class="font-bold">Manual</span> or <span class="font-bold">Auto Play</span> to begin.
            </p>
        `;
        const getOurFatherText = () => `<p class="${scrollTextClass} text-gray-900 font-bold text-center leading-relaxed">Our Father, Who art in heaven, Hallowed be Thy Name. Thy Kingdom come, Thy Will be done, on Earth as it is in Heaven. Give us this day our daily bread, and forgive us our trespasses, as we forgive those who trespass against us. And lead us not into temptation, but deliver us from evil. Amen.</p>`;
        const getHailMaryText = () => `<p class="${scrollTextClass} text-gray-900 font-bold text-center leading-relaxed">Hail Mary, full of grace, the Lord is with thee. Blessed art thou amongst women, and blessed is the fruit of thy womb, Jesus. Holy Mary, Mother of God, pray for us sinners, now and at the hour of our death. Amen.</p>`;
        const getGloryBeFatimaText = () => `<div class="space-y-4"><p class="${scrollTextClass} text-gray-900 font-bold text-center leading-relaxed"><span class="font-semibold underline">Glory Be:</span> Glory be to the Father, and to the Son, and to the Holy Spirit. As it was in the beginning, is now, and ever shall be, world without end. Amen.</p><p class="${scrollTextClass} text-gray-900 font-bold text-center leading-relaxed"><span class="font-semibold underline">Fatima Prayer:</span> O my Jesus, forgive us our sins, save us from the fires of hell, lead all souls to Heaven, especially those in most need of Thy mercy.</p></div>`;


        // --- UI & CORE LOGIC ---

        function saveSettings() {
            localStorage.setItem('rosarySettings', JSON.stringify(appConfig));
        }

        function loadSettings() {
            const saved = localStorage.getItem('rosarySettings');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    // Merge loaded settings, allowing new settings to default if not present
                    appConfig = { ...appConfig, ...parsed }; 
                } catch (e) { 
                    console.error("Error loading settings", e); 
                }
            }
            
            // Set UI elements based on loaded settings
            const modeSelect = document.getElementById('mode-select');
            if(modeSelect) modeSelect.value = appConfig.defaultMode;
            const speedSelect = document.getElementById('speed-select');
            if(speedSelect) speedSelect.value = appConfig.pace.toString();
            const sizeSelect = document.getElementById('size-select');
            if(sizeSelect) sizeSelect.value = appConfig.textSize;
            
            // Set autoContinue checkbox state
            const autoContinueCheckbox = document.getElementById('auto-continue-checkbox');
            if(autoContinueCheckbox) autoContinueCheckbox.checked = appConfig.autoContinue;
        }
        
        function applyTextSizeClass() {
            switch (appConfig.textSize) {
                case 'small':  baseTextClass = 'text-sm'; scrollTextClass = 'text-lg'; break;
                case 'medium': baseTextClass = 'text-base'; scrollTextClass = 'text-xl'; break;
                case 'large':  baseTextClass = 'text-lg'; scrollTextClass = 'text-2xl'; break;
                default:       baseTextClass = 'text-base'; scrollTextClass = 'text-xl';
            }
            // Update modal text if active
            if (modalEl.classList.contains('active') && currentPrayerIndex === -1) {
                 const titleEl = document.getElementById('modal-mystery-title');
                 document.getElementById('dynamic-prayer-content').innerHTML = getInitialContemplationText(titleEl.textContent);
            }
        }

        window.updateSpeed = function(newVal) { appConfig.pace = parseFloat(newVal); saveSettings(); recalcDurations(); }
        window.updateTextSize = function(newVal) { appConfig.textSize = newVal; saveSettings(); applyTextSizeClass(); }
        window.updateDefaultMode = function(newVal) { appConfig.defaultMode = newVal; saveSettings(); }
        window.updateAutoContinue = function(isChecked) { appConfig.autoContinue = isChecked; saveSettings(); }
        window.toggleSettingsPanel = function() { document.getElementById('settings-panel').classList.toggle('active'); }

        function clearStepTimer() {
            if (scrollCompletionTimer) {
                clearTimeout(scrollCompletionTimer);
                scrollCompletionTimer = null;
            }
            const content = document.getElementById('dynamic-prayer-content');
            if(content) {
                content.style.animation = 'none';
                content.offsetHeight; 
                content.style.transform = `translateY(0px)`; 
            }
            isScrolling = false;
        }

        function resetContemplationState() {
            clearStepTimer();
            currentPrayerIndex = -1;
            document.getElementById('rose-container').innerHTML = '';
            document.getElementById('current-prayer-title').textContent = "Contemplation";
            
            manualBtn.classList.remove('bg-yellow-600');
            autoPlayBtn.classList.remove('bg-indigo-700'); 
        }

        function updateBeadHighlight() {
            const beads = document.querySelectorAll('#rose-container .bead');
            beads.forEach(bead => bead.classList.remove('current'));
            if (currentPrayerIndex >= 0 && currentPrayerIndex <= 11) {
                const target = document.getElementById(`bead-${currentPrayerIndex}`);
                if (target) target.classList.add('current');
            }
        }

        function applyScrollAnimation(durationMs, textHtml, title) {
            const content = document.getElementById('dynamic-prayer-content');
            const container = document.getElementById('modal-text-area');
            document.getElementById('current-prayer-title').textContent = title;

            // Reset
            content.style.animation = 'none';
            content.style.transform = `translateY(0px)`;
            content.innerHTML = '';
            
            // Inject
            const wrapper = document.createElement('div');
            wrapper.innerHTML = textHtml.trim();
            content.appendChild(wrapper);
            
            // Buffer
            const buf = document.createElement('div');
            buf.style.height = `${container.offsetHeight}px`;
            buf.style.flexShrink = 0;
            content.appendChild(buf);
            
            // Calc
            const textH = wrapper.offsetHeight;
            if(textH===0) return durationMs;

            const startPos = container.offsetHeight; 
            const endPos = -textH; 
            
            // CSS Vars
            content.style.setProperty('--start-position', `${startPos}px`);
            content.style.setProperty('--end-position', `${endPos}px`);
            
            // Start
            content.style.animation = `prayerScroll ${durationMs/1000}s linear forwards`;
            isScrolling = true;
            
            return durationMs;
        }

        function executePrayerStep(index) {
            clearStepTimer();
            currentPrayerIndex = index;
            
            const roseCont = document.getElementById('rose-container');
            let dur=0, txt='', tit='', cls='';
            
            if(index===0) { dur=D_OF_DURATION; txt=getOurFatherText(); tit="The Our Father"; cls='red-bead'; }
            else if(index<=10) { dur=D_HM_DURATION; txt=getHailMaryText(); tit=`Hail Mary (${index} of 10)`; cls='white-bead'; }
            else if(index===11) { dur=D_GB_DURATION; txt=getGloryBeFatimaText(); tit="Glory Be & Fatima"; cls='red-bead'; }
            else { closeContemplationView(true); return; } // Should not be hit if handleNextStep logic is correct
            
            // Add Bead if new
            if(!document.getElementById(`bead-${index}`)) {
                roseCont.innerHTML += `<span class="bead ${cls}" id="bead-${index}"></span>`;
            }
            updateBeadHighlight();
            
            // Start Animation
            applyScrollAnimation(dur, txt, tit);
            
            // Set completion timer
            scrollCompletionTimer = setTimeout(() => {
                isScrolling = false;
                if(isAutoMode) {
                    handleNextStep();
                }
            }, dur);
        }

        function handleNextStep() {
            const next = currentPrayerIndex + 1;
            if(next <= 11) executePrayerStep(next);
            else closeContemplationView(true); // <--- Passed true for automatic completion
        }

        window.setManualMode = function() {
            isAutoMode = false;
            autoPlayBtn.classList.remove('bg-indigo-700');
            manualBtn.classList.add('bg-yellow-600');
            if (!isScrolling) {
                handleNextStep();
            }
        }

        window.setAutoMode = function() {
            isAutoMode = true;
            manualBtn.classList.remove('bg-yellow-600');
            autoPlayBtn.classList.add('bg-indigo-700');
            if (!isScrolling) {
                handleNextStep();
            }
        }

        window.skipPrayer = function() {
            clearStepTimer(); 
            const next = currentPrayerIndex + 1;
            if (next > 11) { closeContemplationView(); return; }
            
            currentPrayerIndex = next; 
            
            const roseCont = document.getElementById('rose-container');
            let cls = (next===0||next===11)?'red-bead':'white-bead';
            if(!document.getElementById(`bead-${next}`)) {
                roseCont.innerHTML += `<span class="bead ${cls}" id="bead-${next}"></span>`;
            }
            updateBeadHighlight();

            if (isAutoMode) {
                executePrayerStep(next);
            } else {
                let txt='', tit='';
                if(next===0) { txt=getOurFatherText(); tit="The Our Father"; }
                else if(next<=10) { txt=getHailMaryText(); tit=`Hail Mary (${next} of 10)`; }
                else { txt=getGloryBeFatimaText(); tit="Glory Be & Fatima"; }
                
                document.getElementById('current-prayer-title').textContent = tit;
                const content = document.getElementById('dynamic-prayer-content');
                content.style.animation = 'none';
                content.style.transform = `translateY(0px)`;
                content.innerHTML = `<div class="pb-40">${txt}</div>`; 
                isScrolling = false;
            }
        }


        window.openContemplationView = async function(title, imageUrl, index, groupKey) {
            
            if (document.getElementById('settings-panel').classList.contains('active')) toggleSettingsPanel();
            
            resetContemplationState();
            currentMysteryIndex = index;
            currentMysteryGroupKey = groupKey;
            
            // MARK AS COMPLETED (LOCAL STORAGE)
            const mysteryKey = `${groupKey}_${index + 1}`;
            markAsCompleted(mysteryKey);
            
            document.getElementById('modal-mystery-title').textContent = title;
            document.getElementById('modal-image').src = imageUrl;
            document.getElementById('modal-image').alt = title;
            
            modalEl.classList.add('active');
            document.getElementById('list-view').style.display = 'none';
            
            document.getElementById('dynamic-prayer-content').innerHTML = getInitialContemplationText(title);
            
            if (audio && audio.paused && !isMuted) audio.play().catch(e=>{});
            requestWakeLock();

            // Apply Default Mode Setting
            const def = appConfig.defaultMode;
            if (def === 'auto') {
                isAutoMode = true;
                autoPlayBtn.classList.add('bg-indigo-700');
                manualBtn.classList.remove('bg-yellow-600');
                scrollCompletionTimer = setTimeout(handleNextStep, 2000);
            } else {
                isAutoMode = false;
                manualBtn.classList.add('bg-yellow-600');
                autoPlayBtn.classList.remove('bg-indigo-700');
            }
        }
        
        // MODIFIED: Added optional parameter isAutoCompletion
        window.closeContemplationView = function(isAutoCompletion = false) { 
            resetContemplationState();
            releaseWakeLock();
            modalEl.classList.remove('active');
            document.getElementById('list-view').style.display = 'block';
            
            // Re-render the main display to show the updated grayscale status
            updateMainDisplay(selectedDayIndex); 

            // Auto-continue logic - Only continue if isAutoCompletion is true
            if (appConfig.autoContinue && isAutoCompletion) {
                const nextMysteryIndex = currentMysteryIndex + 1;
                const currentMysteryGroup = allMysteries[currentMysteryGroupKey];

                if (nextMysteryIndex < currentMysteryGroup.length) {
                    const nextMystery = currentMysteryGroup[nextMysteryIndex];
                    
                    // Delay to allow list view to display before next modal opens
                    setTimeout(() => {
                        window.openContemplationView(
                            nextMystery.title, 
                            nextMystery.imageUrl, 
                            nextMysteryIndex, 
                            currentMysteryGroupKey
                        );
                    }, 500); 
                }
            }
        }
        
        // --- AUDIO/WAKE/DAY LOGIC ---
        window.toggleMute = function() {
            if (!audio) return;
            isMuted = !isMuted;
            audio.muted = isMuted;
            updateMuteButton(isMuted);
            if (!isMuted && audio.paused) audio.play().catch(e=>{});
        }
        function updateMuteButton(m){
             document.getElementById('mute-status').textContent = m?"Muted":"Unmuted";
             document.getElementById('speaker-icon').innerHTML = m?'&#128263;':'&#128266;';
        }
        function initAudio(){ 
            audio = document.getElementById('background-music'); 
            if(!audio) return;
            audio.volume=0.4; isMuted=false; audio.muted=false; updateMuteButton(false);
            // Autoplay attempt (might be blocked by browser)
            audio.play().catch(e=>{ console.log("Audio autoplay blocked. User interaction required."); });
        }
        
        async function requestWakeLock() { if('wakeLock' in navigator) try{ wakeLockSentinel = await navigator.wakeLock.request('screen'); }catch(e){ console.log("Wake Lock Failed:", e); } }
        function releaseWakeLock() { if(wakeLockSentinel) wakeLockSentinel.release().then(()=>{wakeLockSentinel=null;}).catch(()=>{}); }
        document.addEventListener('visibilitychange', ()=>{ if(wakeLockSentinel!==null && document.visibilityState==='visible') requestWakeLock(); });

        window.selectDay = function(i) { selectedDayIndex=i; updateMainDisplay(i); populateCycleList(realCurrentDayIndex, selectedDayIndex); }
        
        // MODIFIED: loadCompletedStatus now uses Local Storage
        async function updateMainDisplay(i) {
             const name = dayNames[i]; 
             const group = mysterySchedule[i].name;
             const completedStatus = loadCompletedStatus(); // Uses Local Storage now

             document.getElementById('current-day-text').textContent = (i===realCurrentDayIndex) 
                ? `Today, ${name}, we contemplate the:` 
                : `Viewing ${name}: (Actual: ${dayNames[realCurrentDayIndex]} *)`;
             document.getElementById('mystery-group-name').textContent = group;
             
             document.getElementById('daily-mysteries-container').innerHTML = allMysteries[group].map((m,idx)=>createMysteryCard(m,idx, group, completedStatus)).join('');
        }

        function populateCycleList(real, sel) {
            const list = document.getElementById('cycle-list'); list.innerHTML='';
            for(let i=0;i<7;i++) {
                const li = document.createElement('p');
                li.className = (i===sel) ? "font-semibold text-indigo-100 flex justify-between items-center bg-indigo-600 p-2 rounded-md cursor-pointer" : "flex justify-between items-center p-2 text-gray-600 cursor-pointer bg-gray-50 hover:bg-indigo-100 rounded-md";
                li.onclick = ()=>selectDay(i);
                li.innerHTML = `<span class="font-medium">${dayNames[i]}${i===real?' *':''}</span><span>${mysterySchedule[i].name}</span>`;
                list.appendChild(li);
            }
        }

        function createMysteryCard(mystery, index, groupKey, completedStatus) {
            const title = mystery.title;
            const imageUrl = mystery.imageUrl; 
            const mysteryKey = `${groupKey}_${index + 1}`;
            const isCompleted = completedStatus[mysteryKey];
            const filterClass = isCompleted ? 'grayscale' : 'full-color';
            
            return `
                <div id="mystery-${index}" 
                     class="mystery-box bg-white rounded-lg overflow-hidden shadow-md"
                     onclick="openContemplationView('${title.replace(/'/g, "\\'")}', '${imageUrl.replace(/'/g, "\\'")}', ${index}, '${groupKey}')">
                    <div class="relative h-48 bg-gray-200 flex items-center justify-center overflow-hidden mystery-image-container">
                        <img src="${imageUrl}" 
                             alt="${title} contemplation image" 
                             class="w-full h-full object-cover opacity-80 ${filterClass}"
                             onerror="this.onerror=null; this.src='https://placehold.co/400x200/cccccc/000000?text=Image+Load+Error';"
                        >
                        
                        <div class="absolute inset-0 bg-gradient-to-t from-gray-900/70 to-transparent p-4 flex flex-col justify-end text-center">
                            <span class="text-xs font-medium text-white opacity-80">Mystery ${index + 1}</span>
                            <h4 class="text-xl font-bold text-white leading-snug">${title}</h4>
                            ${isCompleted ? '<span class="text-sm font-semibold text-green-300">âœ“ Completed Today</span>' : ''}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function initApp() {
            loadSettings(); 
            calculateBaseDurations();
            applyTextSizeClass(); 
            recalcDurations(); 
            
            // Removed all Firebase setup, now just start the UI.
            updateMainDisplay(selectedDayIndex);
            populateCycleList(realCurrentDayIndex, selectedDayIndex);
            initAudio(); 
        }

        document.addEventListener('DOMContentLoaded', initApp);

    </script>
</body>
</html>
